<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quill & Codex | Complete Novel Planner</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Caveat:wght@400;500;600;700&family=Homemade+Apple&family=Nothing+You+Could+Do&family=Shadows+Into+Light&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        /* ALL YOUR ORIGINAL CSS STAYS EXACTLY THE SAME */
        :root {
            --black: #000000;
            --white: #ffffff;
            --light-gray: #f5f5f5;
            --medium-gray: #e0e0e0;
            --dark-gray: #333333;
            --ink-gray: #222222;
            --paper: #fefefe;
            --border: #d4d4d4;
            --shadow: rgba(0,0,0,0.1);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Caveat', cursive;
            background-color: var(--paper);
            color: var(--ink-gray);
            line-height: 1.6;
            min-height: 100vh;
            background-image: 
                repeating-linear-gradient(0deg, transparent, transparent 28px, rgba(0,0,0,0.1) 28px, rgba(0,0,0,0.1) 29px);
            letter-spacing: 0.5px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
        }
        
        /* Header */
        .header {
            text-align: center;
            padding: 40px 20px 20px;
            margin-bottom: 20px;
            position: relative;
        }
        
        .title {
            font-family: 'Homemade Apple', cursive;
            font-size: 4rem;
            color: var(--black);
            margin-bottom: 5px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
            letter-spacing: 3px;
        }
        
        .subtitle {
            font-family: 'Nothing You Could Do', cursive;
            font-size: 1.6rem;
            color: var(--dark-gray);
            margin-top: 5px;
            font-weight: 400;
            letter-spacing: 2px;
        }
        
        .divider {
            width: 300px;
            height: 2px;
            background: var(--black);
            margin: 25px auto;
            opacity: 0.3;
        }
        
        /* Main Content */
        .main-content {
            background: var(--white);
            border-radius: 4px;
            padding: 30px;
            box-shadow: 0 4px 20px var(--shadow);
            border: 1px solid var(--border);
            min-height: 700px;
            position: relative;
        }
        
        .content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border);
        }
        
        .section-title {
            font-family: 'Homemade Apple', cursive;
            font-size: 2.2rem;
            color: var(--black);
            letter-spacing: 1px;
        }
        
        .page-number {
            font-family: 'Caveat', cursive;
            color: var(--dark-gray);
            font-size: 1.4rem;
            padding: 5px 15px;
            border-radius: 0;
            border: 1px solid var(--border);
            background: var(--white);
        }
        
        /* Tabs */
        .tabs {
            display: flex;
            flex-wrap: wrap;
            gap: 2px;
            margin-bottom: 25px;
            border-bottom: 2px solid var(--black);
            padding-bottom: 0;
        }
        
        .tab-btn {
            padding: 12px 20px;
            background: transparent;
            border: none;
            border-radius: 0;
            font-family: 'Shadows Into Light', cursive;
            font-weight: 600;
            color: var(--dark-gray);
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1.2rem;
            letter-spacing: 1px;
            position: relative;
            bottom: -2px;
            white-space: nowrap;
        }
        
        .tab-btn.active {
            background: var(--black);
            color: var(--white);
            border: 1px solid var(--black);
            border-bottom: none;
        }
        
        .tab-btn:hover:not(.active) {
            background: var(--light-gray);
            color: var(--black);
        }
        
        .tab-content {
            display: none;
            min-height: 500px;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Writing Area */
        .writing-area {
            width: 100%;
            height: 550px;
            padding: 30px;
            border: 1px solid var(--border);
            border-radius: 0;
            font-family: 'Caveat', cursive;
            font-size: 1.4rem;
            line-height: 2;
            color: var(--ink-gray);
            background: var(--white);
            resize: none;
            outline: none;
            box-shadow: inset 0 1px 3px var(--shadow);
        }
        
        .writing-area::placeholder {
            color: var(--medium-gray);
            opacity: 0.8;
            font-style: italic;
        }
        
        /* Tool Cards */
        .tool-card {
            background: var(--white);
            border: 1px solid var(--border);
            border-radius: 0;
            padding: 25px;
            margin-bottom: 25px;
            position: relative;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px var(--shadow);
        }
        
        .tool-card:hover {
            box-shadow: 0 4px 10px var(--shadow);
        }
        
        .delete-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 30px;
            height: 30px;
            border-radius: 0;
            background: transparent;
            color: var(--dark-gray);
            border: 1px solid var(--border);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            font-family: 'Caveat', cursive;
        }
        
        .delete-btn:hover {
            background: var(--black);
            color: var(--white);
        }
        
        .tool-card-title {
            font-family: 'Homemade Apple', cursive;
            font-size: 1.8rem;
            color: var(--black);
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border);
            letter-spacing: 1px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--dark-gray);
            font-weight: 600;
            font-size: 1.2rem;
            font-family: 'Shadows Into Light', cursive;
        }
        
        .form-input {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--border);
            border-radius: 0;
            font-family: 'Caveat', cursive;
            font-size: 1.2rem;
            color: var(--ink-gray);
            background: var(--white);
            transition: all 0.3s ease;
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--black);
            box-shadow: 0 0 0 1px rgba(0,0,0,0.1);
        }
        
        .form-textarea {
            min-height: 120px;
            resize: vertical;
        }
        
        .form-textarea-large {
            min-height: 200px;
            resize: vertical;
        }
        
        /* Image Upload Area */
        .image-upload-area {
            border: 2px dashed var(--border);
            border-radius: 0;
            padding: 40px 20px;
            text-align: center;
            color: var(--dark-gray);
            margin: 20px 0;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .image-upload-area:hover {
            border-color: var(--black);
            background: var(--light-gray);
        }
        
        .image-upload-area i {
            font-size: 3rem;
            margin-bottom: 15px;
            color: var(--dark-gray);
        }
        
        .image-preview-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .image-preview {
            position: relative;
            border: 1px solid var(--border);
            padding: 10px;
            background: var(--white);
        }
        
        .image-preview img {
            width: 100%;
            height: 150px;
            object-fit: cover;
            display: block;
        }
        
        .remove-image {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(0,0,0,0.7);
            color: white;
            border: none;
            width: 25px;
            height: 25px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        
        /* Buttons */
        .btn {
            background: var(--white);
            color: var(--black);
            border: 2px solid var(--black);
            border-radius: 0;
            padding: 12px 25px;
            font-family: 'Shadows Into Light', cursive;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
            font-size: 1.1rem;
            letter-spacing: 1px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn:hover {
            background: var(--black);
            color: var(--white);
            transform: translateY(-2px);
        }
        
        .btn-primary {
            background: var(--black);
            color: var(--white);
        }
        
        .btn-primary:hover {
            background: var(--dark-gray);
        }
        
        /* Scene-Timeline Connection */
        .scene-timeline-connection {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }
        
        @media (max-width: 900px) {
            .scene-timeline-connection {
                grid-template-columns: 1fr;
            }
        }
        
        .connection-panel {
            border: 1px solid var(--border);
            padding: 20px;
            background: var(--white);
        }
        
        .connection-title {
            font-family: 'Homemade Apple', cursive;
            font-size: 1.5rem;
            color: var(--black);
            margin-bottom: 15px;
            border-bottom: 1px solid var(--border);
            padding-bottom: 8px;
        }
        
        /* Control Panel */
        .control-panel {
            background: var(--white);
            border-radius: 0;
            padding: 25px;
            box-shadow: 0 2px 10px var(--shadow);
            border: 1px solid var(--border);
            height: fit-content;
        }
        
        .control-btn {
            display: block;
            width: 100%;
            padding: 15px;
            margin-bottom: 12px;
            background: var(--white);
            color: var(--black);
            border: 2px solid var(--black);
            border-radius: 0;
            font-family: 'Shadows Into Light', cursive;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            font-size: 1.2rem;
            letter-spacing: 1px;
        }
        
        .control-btn:hover {
            background: var(--black);
            color: var(--white);
            transform: translateY(-2px);
        }
        
        /* Stats */
        .stats-box {
            background: var(--white);
            border-radius: 0;
            padding: 25px;
            margin-top: 30px;
            border: 2px solid var(--black);
        }
        
        .stats-title {
            font-family: 'Homemade Apple', cursive;
            font-size: 1.6rem;
            color: var(--black);
            margin-bottom: 20px;
            text-align: center;
            letter-spacing: 1px;
        }
        
        .stat-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid var(--border);
            font-size: 1.2rem;
        }
        
        .stat-item:last-child {
            border-bottom: none;
        }
        
        .stat-value {
            font-weight: 600;
            color: var(--black);
        }
        
        /* Footer */
        .footer {
            text-align: center;
            padding: 30px 20px;
            margin-top: 40px;
            color: var(--dark-gray);
            font-size: 1rem;
            border-top: 2px solid var(--border);
            font-family: 'Nothing You Could Do', cursive;
        }
        
        /* Grid Layout */
        .grid-container {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 30px;
        }
        
        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--white);
            color: var(--black);
            padding: 15px 25px;
            border-radius: 0;
            box-shadow: 0 4px 15px var(--shadow);
            display: none;
            z-index: 1000;
            animation: slideIn 0.3s ease;
            border: 2px solid var(--black);
            font-family: 'Caveat', cursive;
            font-size: 1.2rem;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        /* Word Count */
        .word-count {
            position: absolute;
            bottom: 10px;
            right: 10px;
            color: var(--dark-gray);
            font-family: 'Nothing You Could Do', cursive;
            font-size: 1rem;
        }
        
        /* Responsive */
        @media (max-width: 1100px) {
            .grid-container {
                grid-template-columns: 1fr;
            }
            
            .tabs {
                overflow-x: auto;
                flex-wrap: nowrap;
            }
        }
        
        @media (max-width: 768px) {
            .title {
                font-size: 2.8rem;
            }
            
            .tab-btn {
                padding: 10px 15px;
                font-size: 1rem;
            }
            
            .writing-area {
                height: 400px;
                font-size: 1.2rem;
            }
            
            .main-content {
                padding: 20px;
            }
        }
        
        @media (max-width: 480px) {
            .title {
                font-size: 2.2rem;
            }
            
            .subtitle {
                font-size: 1.2rem;
            }
            
            .section-title {
                font-size: 1.6rem;
            }
        }
        
        /* Ink Blots */
        .ink-blot {
            position: absolute;
            opacity: 0.05;
            z-index: -1;
        }
        
        .ink-blot-1 {
            top: 10%;
            left: 5%;
            width: 100px;
            height: 100px;
            background: radial-gradient(circle, var(--black) 0%, transparent 70%);
        }
        
        .ink-blot-2 {
            bottom: 10%;
            right: 5%;
            width: 150px;
            height: 150px;
            background: radial-gradient(circle, var(--black) 0%, transparent 70%);
        }
        
        /* Tag Input */
        .tag-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }
        
        .tag {
            background: var(--light-gray);
            padding: 5px 12px;
            border: 1px solid var(--border);
            font-size: 0.9rem;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        
        .tag-remove {
            cursor: pointer;
            color: var(--dark-gray);
        }
        
        /* Timeline Visual */
        .timeline-visual {
            margin-top: 20px;
            padding: 20px;
            border: 1px solid var(--border);
            background: var(--white);
            min-height: 300px;
            position: relative;
        }
        
        .timeline-event {
            position: relative;
            margin-bottom: 20px;
            padding-left: 30px;
        }
        
        .timeline-dot {
            position: absolute;
            left: 0;
            top: 5px;
            width: 15px;
            height: 15px;
            background: var(--black);
            border-radius: 50%;
        }
        
        .timeline-content {
            padding: 10px;
            border: 1px solid var(--border);
            background: var(--light-gray);
        }
        
        /* Outline Cards */
        .outline-card {
            background: var(--white);
            border: 1px solid var(--border);
            padding: 20px;
            margin-bottom: 15px;
            cursor: move;
        }
        
        .outline-card:hover {
            border-color: var(--black);
        }
        
        .outline-number {
            font-family: 'Homemade Apple', cursive;
            font-size: 1.4rem;
            color: var(--black);
            margin-bottom: 10px;
        }
        
        /* Character Images */
        .character-image-preview {
            width: 100%;
            max-width: 200px;
            height: 200px;
            object-fit: cover;
            border: 1px solid var(--border);
            margin: 10px 0;
        }
        
        /* ===== NEW AI STYLES ===== */
        .ai-image-section {
            margin-top: 20px;
            padding: 20px;
            border: 2px dashed var(--border);
            border-radius: 0;
            background: var(--light-gray);
        }
        
        .ai-image-title {
            font-family: 'Homemade Apple', cursive;
            font-size: 1.6rem;
            color: var(--black);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .ai-prompt-box {
            width: 100%;
            padding: 15px;
            border: 1px solid var(--border);
            border-radius: 0;
            font-family: 'Caveat', cursive;
            font-size: 1.2rem;
            margin-bottom: 15px;
            background: var(--white);
            resize: vertical;
            min-height: 100px;
        }
        
        .ai-style-select {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .style-option {
            padding: 10px;
            border: 2px solid var(--border);
            border-radius: 0;
            background: var(--white);
            cursor: pointer;
            text-align: center;
            font-family: 'Shadows Into Light', cursive;
            transition: all 0.3s ease;
        }
        
        .style-option:hover {
            border-color: var(--black);
            background: var(--light-gray);
        }
        
        .style-option.selected {
            border-color: var(--black);
            background: var(--black);
            color: var(--white);
        }
        
        .ai-generate-btn {
            background: linear-gradient(135deg, #ff6b6b 0%, #4ecdc4 100%);
            color: white;
            border: none;
            border-radius: 0;
            padding: 15px 30px;
            font-family: 'Shadows Into Light', cursive;
            font-weight: 600;
            font-size: 1.2rem;
            cursor: pointer;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.3s ease;
        }
        
        .ai-generate-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.4);
        }
        
        .ai-generate-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .ai-loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .ai-loading-spinner {
            border: 3px solid var(--light-gray);
            border-top: 3px solid var(--black);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .ai-results {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .ai-result-image {
            position: relative;
            border: 1px solid var(--border);
            padding: 10px;
            background: var(--white);
        }
        
        .ai-result-image img {
            width: 100%;
            height: 200px;
            object-fit: cover;
            display: block;
        }
        
        .ai-image-actions {
            display: flex;
            gap: 5px;
            margin-top: 10px;
        }
        
        .ai-save-btn, .ai-regenerate-btn {
            flex: 1;
            padding: 8px;
            border: none;
            border-radius: 0;
            font-family: 'Caveat', cursive;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .ai-save-btn {
            background: var(--black);
            color: var(--white);
        }
        
        .ai-save-btn:hover {
            background: var(--dark-gray);
        }
        
        .ai-regenerate-btn {
            background: var(--light-gray);
            color: var(--black);
            border: 1px solid var(--border);
        }
        
        .ai-regenerate-btn:hover {
            background: var(--medium-gray);
        }
        
        .ai-api-key-section {
            margin-top: 20px;
            padding: 15px;
            background: var(--white);
            border: 1px solid var(--border);
        }
        
        .api-key-input {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 0;
            font-family: 'Caveat', cursive;
            font-size: 1.1rem;
            margin-bottom: 10px;
        }
        
        .api-info {
            font-size: 0.9rem;
            color: var(--dark-gray);
            margin-top: 10px;
            font-family: 'Nothing You Could Do', cursive;
        }
        
        .api-info a {
            color: var(--black);
            text-decoration: underline;
        }
        
        .image-source-badge {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 2px 6px;
            font-size: 0.8rem;
            font-family: 'Shadows Into Light', cursive;
        }
    </style>
</head>
<body>
    <div class="ink-blot ink-blot-1"></div>
    <div class="ink-blot ink-blot-2"></div>
    
    <div class="container">
        <!-- Header -->
        <header class="header">
            <h1 class="title">Quill & Codex</h1>
            <p class="subtitle">Complete Novel Planning Studio</p>
            <div class="divider"></div>
        </header>

        <div class="grid-container">
            <!-- Main Content -->
            <main class="main-content">
                <div class="content-header">
                    <h2 class="section-title" id="currentTabTitle">Characters</h2>
                    <div class="page-number">Codex Page <span id="currentPage">1</span></div>
                </div>
                
                <!-- Tabs -->
                <div class="tabs">
                    <button class="tab-btn" data-tab="premise">Premise</button>
                    <button class="tab-btn" data-tab="world">World</button>
                    <button class="tab-btn active" data-tab="characters">Characters</button>
                    <button class="tab-btn" data-tab="scenes">Scenes</button>
                    <button class="tab-btn" data-tab="timeline">Timeline</button>
                    <button class="tab-btn" data-tab="outline">Outline</button>
                    <button class="tab-btn" data-tab="notes">Notes</button>
                    <button class="tab-btn" data-tab="writing">Writing</button>
                    <button class="tab-btn" data-tab="preview">Preview</button>
                </div>
                
                <!-- PREMISE TAB -->
                <div class="tab-content" id="premise-tab">
                    <div class="form-group">
                        <label for="premiseTheme">Story Theme / Logline:</label>
                        <textarea class="form-input form-textarea-large" id="premiseTheme" placeholder="A one-sentence summary of your story's core concept. Example: 'A young wizard must defeat a dark lord while navigating the complexities of growing up.'"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="premiseCore">Core Premise:</label>
                        <textarea class="form-input form-textarea-large" id="premiseCore" placeholder="Expand on your theme. What makes your story unique? What's the central conflict?"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="premiseCharacters">Central Characters (Premise):</label>
                        <textarea class="form-input form-textarea" id="premiseCharacters" placeholder="How do the main characters relate to your premise?"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="premiseWorld">World Connection:</label>
                        <textarea class="form-input form-textarea" id="premiseWorld" placeholder="How does your world support or challenge your premise?"></textarea>
                    </div>
                    
                    <button class="btn btn-primary" onclick="savePremise()">
                        <i class="fas fa-save"></i> Save Premise
                    </button>
                </div>
                
                <!-- WORLD TAB -->
                <div class="tab-content" id="world-tab">
                    <div id="worldContainer"></div>
                    
                    <div class="tool-card">
                        <h3 class="tool-card-title">Add World Element</h3>
                        <div class="form-group">
                            <label for="worldCategory">Category:</label>
                            <select class="form-input" id="worldCategory">
                                <option value="geography">Geography & Locations</option>
                                <option value="culture">Culture & Society</option>
                                <option value="magic">Magic System</option>
                                <option value="technology">Technology</option>
                                <option value="history">History & Lore</option>
                                <option value="politics">Politics & Factions</option>
                                <option value="religion">Religion & Beliefs</option>
                                <option value="creatures">Creatures & Races</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="worldName">Element Name:</label>
                            <input type="text" class="form-input" id="worldName" placeholder="e.g., Kingdom of Eldoria, Magic of Aetherium">
                        </div>
                        <div class="form-group">
                            <label for="worldDescription">Detailed Description:</label>
                            <textarea class="form-input form-textarea-large" id="worldDescription" placeholder="Describe this world element in detail..."></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label>Inspiration Images (Optional):</label>
                            <div class="image-upload-area" onclick="document.getElementById('worldImageUpload').click()">
                                <i class="fas fa-image"></i>
                                <p>Click to upload inspiration images</p>
                                <p style="font-size: 0.9rem; color: var(--dark-gray);">(Supports JPG, PNG, GIF)</p>
                            </div>
                            <input type="file" id="worldImageUpload" accept="image/*" multiple style="display: none;" onchange="handleWorldImageUpload(event)">
                            
                            <div class="image-preview-container" id="worldImagePreview"></div>
                        </div>
                        
                        <div class="form-group">
                            <label for="worldTags">Tags (comma separated):</label>
                            <input type="text" class="form-input" id="worldTags" placeholder="fantasy, kingdom, magical, ancient">
                        </div>
                        
                        <button class="btn btn-primary" onclick="saveWorldElement()">
                            <i class="fas fa-plus"></i> Add World Element
                        </button>
                    </div>
                </div>
                
                <!-- CHARACTERS TAB (WITH PARTYROCK AI) -->
                <div class="tab-content active" id="characters-tab">
                    <div id="charactersContainer">
                        <!-- Existing characters will be added here -->
                    </div>
                    
                    <div class="tool-card">
                        <h3 class="tool-card-title">Create Character with AI</h3>
                        
                        <!-- Basic Character Info -->
                        <div class="form-group">
                            <label for="charName">Character Name:</label>
                            <input type="text" class="form-input" id="charName" placeholder="Full name">
                        </div>
                        
                        <div class="form-group">
                            <label>Role in Story:</label>
                            <select class="form-input" id="charRole">
                                <option value="protagonist">Protagonist</option>
                                <option value="antagonist">Antagonist</option>
                                <option value="supporting">Supporting Character</option>
                                <option value="mentor">Mentor</option>
                                <option value="love-interest">Love Interest</option>
                                <option value="sidekick">Sidekick</option>
                                <option value="villain">Villain</option>
                                <option value="foil">Foil</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="charAppearance">Physical Appearance:</label>
                            <textarea class="form-input form-textarea" id="charAppearance" 
                                placeholder="Age, height, build, hair color/style, eye color, distinctive features, clothing style, accessories...
Example: 28 years old, 6'2", athletic build, shoulder-length black hair with silver streaks, piercing blue eyes, scar across left cheek, wears practical leather armor, carries an ancient family heirloom sword."></textarea>
                        </div>
                        
                        <!-- PARTYROCK AI IMAGE GENERATION SECTION -->
                        <div class="ai-image-section">
                            <h3 class="ai-image-title">
                                <i class="fas fa-robot"></i> AI Character Image Generator
                            </h3>
                            
                            <p style="margin-bottom: 15px; font-family: 'Caveat', cursive; font-size: 1.2rem;">
                                Describe your character's appearance and AI will generate visual references:
                            </p>
                            
                            <textarea 
                                class="ai-prompt-box" 
                                id="aiImagePrompt" 
                                placeholder="Example: A fierce elven warrior with silver hair, emerald eyes, intricate facial tattoos, wearing leather armor and carrying a glowing sword. Fantasy art style, detailed, dramatic lighting."
                            ></textarea>
                            
                            <button class="btn" onclick="fillPromptFromDescription()" style="margin-bottom: 15px;">
                                <i class="fas fa-sync-alt"></i> Use Physical Description for AI
                            </button>
                            
                            <div class="form-group">
                                <label>Art Style:</label>
                                <div class="ai-style-select">
                                    <div class="style-option selected" data-style="fantasy">
                                        <i class="fas fa-hat-wizard"></i> Fantasy Art
                                    </div>
                                    <div class="style-option" data-style="realistic">
                                        <i class="fas fa-camera"></i> Realistic
                                    </div>
                                    <div class="style-option" data-style="anime">
                                        <i class="fas fa-moon"></i> Anime Style
                                    </div>
                                    <div class="style-option" data-style="watercolor">
                                        <i class="fas fa-paint-brush"></i> Watercolor
                                    </div>
                                </div>
                            </div>
                            
                            <button class="ai-generate-btn" onclick="generateAIImage()" id="generateAIBtn">
                                <i class="fas fa-wand-magic-sparkles"></i> Generate Character Images
                            </button>
                            
                            <div class="ai-loading" id="aiLoading">
                                <div class="ai-loading-spinner"></div>
                                <p>AI is creating your character... This takes about 20 seconds</p>
                            </div>
                            
                            <div class="ai-results" id="aiResults"></div>
                            
                            <div class="ai-api-key-section">
                                <p class="api-info">
                                    <i class="fas fa-info-circle"></i> Using AI-powered image generation. 
                                    Images are generated using PartyRock integration.
                                </p>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="charPersonality">Personality & Traits:</label>
                            <textarea class="form-input form-textarea" id="charPersonality" placeholder="Personality, motivations, fears, desires..."></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label for="charBackstory">Backstory:</label>
                            <textarea class="form-input form-textarea-large" id="charBackstory" placeholder="Character history, important events..."></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label for="charArc">Character Arc:</label>
                            <textarea class="form-input form-textarea" id="charArc" placeholder="How does the character change throughout the story?"></textarea>
                        </div>
                        
                        <!-- Manual Image Upload (still available) -->
                        <div class="form-group">
                            <label>Manual Image Upload (Optional):</label>
                            <div class="image-upload-area" onclick="document.getElementById('charImageUpload').click()">
                                <i class="fas fa-cloud-upload-alt"></i>
                                <p>Upload your own reference images</p>
                                <p style="font-size: 0.9rem; color: var(--dark-gray);">(Face claims, costume ideas, etc.)</p>
                            </div>
                            <input type="file" id="charImageUpload" accept="image/*" multiple style="display: none;" onchange="handleCharImageUpload(event)">
                            
                            <div class="image-preview-container" id="charImagePreview"></div>
                        </div>
                        
                        <div class="form-group">
                            <label for="charTags">Tags (comma separated):</label>
                            <input type="text" class="form-input" id="charTags" placeholder="brave, mysterious, royal, magical">
                        </div>
                        
                        <button class="btn btn-primary" onclick="saveCharacter()">
                            <i class="fas fa-plus"></i> Create Character
                        </button>
                    </div>
                </div>
                
                <!-- SCENES TAB -->
                <div class="tab-content" id="scenes-tab">
                    <div class="scene-timeline-connection">
                        <div class="connection-panel">
                            <h3 class="connection-title">Important Scenes</h3>
                            <div id="scenesContainer"></div>
                        </div>
                        
                        <div class="connection-panel">
                            <h3 class="connection-title">Add New Scene</h3>
                            <div class="form-group">
                                <label for="sceneTitle">Scene Title:</label>
                                <input type="text" class="form-input" id="sceneTitle" placeholder="The Great Revelation, Final Battle, etc.">
                            </div>
                            <div class="form-group">
                                <label for="sceneType">Scene Type:</label>
                                <select class="form-input" id="sceneType">
                                    <option value="plot-twist">Plot Twist</option>
                                    <option value="climax">Climax</option>
                                    <option value="revelation">Revelation</option>
                                    <option value="confrontation">Confrontation</option>
                                    <option value="emotional">Emotional Beat</option>
                                    <option value="action">Action Sequence</option>
                                    <option value="dialogue">Important Dialogue</option>
                                    <option value="character">Character Development</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="sceneCharacters">Involved Characters:</label>
                                <input type="text" class="form-input" id="sceneCharacters" placeholder="Character names separated by commas">
                            </div>
                            <div class="form-group">
                                <label for="sceneLocation">Location:</label>
                                <input type="text" class="form-input" id="sceneLocation" placeholder="Where does this happen?">
                            </div>
                            <div class="form-group">
                                <label for="sceneDescription">Scene Description:</label>
                                <textarea class="form-input form-textarea-large" id="sceneDescription" placeholder="What happens in this scene? Include important dialogue, actions, and emotional beats..."></textarea>
                            </div>
                            <div class="form-group">
                                <label for="sceneImpact">Impact on Story:</label>
                                <textarea class="form-input form-textarea" id="sceneImpact" placeholder="How does this scene change the story?"></textarea>
                            </div>
                            <button class="btn btn-primary" onclick="saveScene()">
                                <i class="fas fa-plus"></i> Add Scene
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- TIMELINE TAB -->
                <div class="tab-content" id="timeline-tab">
                    <div class="scene-timeline-connection">
                        <div class="connection-panel">
                            <h3 class="connection-title">All Scenes (Drag to Timeline)</h3>
                            <div id="scenesForTimeline"></div>
                        </div>
                        
                        <div class="connection-panel">
                            <h3 class="connection-title">Story Timeline</h3>
                            <div class="form-group">
                                <label for="timelineScale">Timeline Scale:</label>
                                <select class="form-input" id="timelineScale">
                                    <option value="chapters">By Chapters</option>
                                    <option value="acts">By Acts</option>
                                    <option value="time">By Time Period</option>
                                </select>
                            </div>
                            
                            <div id="timelineVisual" class="timeline-visual">
                                <p>Drag scenes from the left panel to add them to the timeline.</p>
                            </div>
                            
                            <div class="form-group">
                                <label for="timelineNotes">Timeline Notes:</label>
                                <textarea class="form-input form-textarea" id="timelineNotes" placeholder="Notes about the overall timeline..."></textarea>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- OUTLINE TAB -->
                <div class="tab-content" id="outline-tab">
                    <div id="outlineContainer"></div>
                    
                    <div class="tool-card">
                        <h3 class="tool-card-title">Add Chapter to Outline</h3>
                        <div class="form-group">
                            <label for="outlineChapterNumber">Chapter Number:</label>
                            <input type="text" class="form-input" id="outlineChapterNumber" placeholder="Chapter 1, Prologue, etc.">
                        </div>
                        <div class="form-group">
                            <label for="outlineChapterTitle">Chapter Title:</label>
                            <input type="text" class="form-input" id="outlineChapterTitle" placeholder="Title of this chapter">
                        </div>
                        <div class="form-group">
                            <label for="outlinePOV">Point of View:</label>
                            <input type="text" class="form-input" id="outlinePOV" placeholder="Which character's POV?">
                        </div>
                        <div class="form-group">
                            <label for="outlineSynopsis">Chapter Synopsis:</label>
                            <textarea class="form-input form-textarea-large" id="outlineSynopsis" placeholder="What happens in this chapter? Include which scenes from your scene list occur here..."></textarea>
                        </div>
                        <div class="form-group">
                            <label for="outlinePurpose">Chapter Purpose:</label>
                            <textarea class="form-input form-textarea" id="outlinePurpose" placeholder="What is this chapter's purpose in the story?"></textarea>
                        </div>
                        <button class="btn btn-primary" onclick="saveChapterOutline()">
                            <i class="fas fa-plus"></i> Add Chapter
                        </button>
                    </div>
                </div>
                
                <!-- NOTES TAB -->
                <div class="tab-content" id="notes-tab">
                    <div id="notesContainer"></div>
                    
                    <div class="tool-card">
                        <h3 class="tool-card-title">Add Note</h3>
                        <div class="form-group">
                            <label for="noteTitle">Note Title:</label>
                            <input type="text" class="form-input" id="noteTitle" placeholder="Title of this note">
                        </div>
                        <div class="form-group">
                            <label for="noteCategory">Category:</label>
                            <select class="form-input" id="noteCategory">
                                <option value="idea">Story Idea</option>
                                <option value="research">Research</option>
                                <option value="dialogue">Dialogue Idea</option>
                                <option value="plot-hole">Plot Hole to Fix</option>
                                <option value="character">Character Idea</option>
                                <option value="world">World Idea</option>
                                <option value="theme">Theme Development</option>
                                <option value="misc">Miscellaneous</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="noteContent">Note Content:</label>
                            <textarea class="form-input form-textarea-large" id="noteContent" placeholder="Write your note here..."></textarea>
                        </div>
                        <button class="btn btn-primary" onclick="saveNote()">
                            <i class="fas fa-plus"></i> Add Note
                        </button>
                    </div>
                </div>
                
                <!-- WRITING TAB -->
                <div class="tab-content" id="writing-tab">
                    <div class="form-group">
                        <label for="writingChapter">Current Chapter:</label>
                        <select class="form-input" id="writingChapter">
                            <option value="">Select a chapter to write...</option>
                        </select>
                    </div>
                    
                    <textarea class="writing-area" placeholder="Begin writing your story here... You can reference your characters, scenes, and timeline from the other tabs..." id="mainWritingArea"></textarea>
                    <div class="word-count">Words: <span id="wordCount">0</span> | Characters: <span id="charCount">0</span></div>
                </div>
                
                <!-- PREVIEW TAB -->
                <div class="tab-content" id="preview-tab">
                    <div id="previewContainer" style="padding: 20px; background: var(--white); min-height: 500px; overflow-y: auto;"></div>
                    <button class="btn btn-primary" onclick="generateAestheticPDF()" style="margin-top: 20px; width: 100%; padding: 15px;">
                        <i class="fas fa-download"></i> Generate Aesthetic Codex (Handwritten PDF)
                    </button>
                </div>
            </main>

            <!-- Controls Sidebar -->
            <aside class="control-panel">
                <div style="margin-bottom: 30px;">
                    <h3 style="font-family: 'Homemade Apple', cursive; font-size: 1.8rem; color: var(--black); margin-bottom: 15px; letter-spacing: 1px;">Manuscript Info</h3>
                    <div class="form-group">
                        <label for="novelTitle">Novel Title:</label>
                        <input type="text" id="novelTitle" class="form-input" placeholder="Your Novel Title">
                    </div>
                    <div class="form-group">
                        <label for="authorName">Author:</label>
                        <input type="text" id="authorName" class="form-input" placeholder="Author Name">
                    </div>
                    <div class="form-group">
                        <label for="genre">Genre(s):</label>
                        <input type="text" id="genre" class="form-input" placeholder="Fantasy, Romance, Mystery, etc.">
                    </div>
                    <div class="form-group">
                        <label for="targetAudience">Target Audience:</label>
                        <input type="text" id="targetAudience" class="form-input" placeholder="Young Adult, Adult, etc.">
                    </div>
                </div>
                
                <h3 style="font-family: 'Homemade Apple', cursive; font-size: 1.8rem; color: var(--black); margin-bottom: 15px; letter-spacing: 1px;">Codex Controls</h3>
                
                <button class="control-btn" onclick="saveEverything()">
                    <i class="fas fa-save"></i> Save Everything
                </button>
                
                <button class="control-btn" onclick="loadEverything()">
                    <i class="fas fa-folder-open"></i> Load Codex
                </button>
                
                <button class="control-btn" onclick="generateAestheticPDF()">
                    <i class="fas fa-file-pdf"></i> Generate Codex PDF
                </button>
                
                <button class="control-btn" onclick="exportToJSON()">
                    <i class="fas fa-file-export"></i> Export as JSON
                </button>
                
                <button class="control-btn clear" onclick="clearEverything()">
                    <i class="fas fa-broom"></i> Clear All
                </button>
                
                <!-- Stats -->
                <div class="stats-box">
                    <h3 class="stats-title">Writing Stats</h3>
                    <div class="stat-item">
                        <span>Total Words:</span>
                        <span class="stat-value" id="statWords">0</span>
                    </div>
                    <div class="stat-item">
                        <span>Characters:</span>
                        <span class="stat-value" id="statCharacters">0</span>
                    </div>
                    <div class="stat-item">
                        <span>Scenes:</span>
                        <span class="stat-value" id="statScenes">0</span>
                    </div>
                    <div class="stat-item">
                        <span>Chapters:</span>
                        <span class="stat-value" id="statChapters">0</span>
                    </div>
                    <div class="stat-item">
                        <span>World Elements:</span>
                        <span class="stat-value" id="statWorld">0</span>
                    </div>
                    <div class="stat-item">
                        <span>Notes:</span>
                        <span class="stat-value" id="statNotes">0</span>
                    </div>
                </div>
                
                <!-- Quick Navigation -->
                <div style="margin-top: 30px; border-top: 2px solid var(--border); padding-top: 20px;">
                    <h3 style="font-family: 'Homemade Apple', cursive; font-size: 1.6rem; color: var(--black); margin-bottom: 15px; letter-spacing: 1px;">Quick Jump</h3>
                    <select class="form-input" id="quickJump" style="margin-bottom: 15px;">
                        <option value="">Jump to Tab...</option>
                        <option value="premise">Premise</option>
                        <option value="world">World Building</option>
                        <option value="characters">Characters</option>
                        <option value="scenes">Important Scenes</option>
                        <option value="timeline">Timeline</option>
                        <option value="outline">Chapter Outline</option>
                        <option value="notes">Notes</option>
                        <option value="writing">Writing</option>
                        <option value="preview">Preview</option>
                    </select>
                </div>
            </aside>
        </div>

        <!-- Footer -->
        <footer class="footer">
            <p>Quill & Codex | Complete Novel Planning Studio | All data saved locally in your browser</p>
            <p style="margin-top: 10px; font-size: 0.9rem;">
                <i class="fas fa-feather-alt" style="color: var(--black);"></i>
                Where every story begins with a plan
            </p>
        </footer>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification"></div>

    <!-- Hidden file input for JSON import -->
    <input type="file" id="jsonImport" accept=".json" style="display: none;">

    <script>
        // =====================
        // STATE MANAGEMENT
        // =====================
        
        let codex = {
            premise: {
                theme: '',
                core: '',
                characters: '',
                world: ''
            },
            world: [],
            characters: [],
            scenes: [],
            timeline: [],
            outline: [],
            notes: [],
            writing: {},
            metadata: {
                title: 'Untitled Manuscript',
                author: '',
                genre: '',
                audience: '',
                created: new Date().toISOString(),
                modified: new Date().toISOString()
            }
        };

        let worldImages = [];
        let characterImages = [];
        let aiGeneratedImages = [];
        let selectedStyle = 'fantasy';
        
        // =====================
        // PARTYROCK AI INTEGRATION
        // =====================
        
        // Initialize AI when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Setup style selection
            document.querySelectorAll('.style-option').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.style-option').forEach(opt => opt.classList.remove('selected'));
                    this.classList.add('selected');
                    selectedStyle = this.getAttribute('data-style');
                });
            });
        });
        
        // Fill AI prompt from physical description
        function fillPromptFromDescription() {
            const description = document.getElementById('charAppearance').value;
            if (description.trim()) {
                document.getElementById('aiImagePrompt').value = 
                    `Character appearance: ${description}. ${getStylePrompt(selectedStyle)}`;
                showNotification('AI prompt filled from description!', 'success');
            } else {
                showNotification('Please enter a physical description first', 'warning');
            }
        }
        
        // Get style-specific prompts
        function getStylePrompt(style) {
            const prompts = {
                'fantasy': 'Fantasy art, detailed, epic, dramatic lighting, character concept art',
                'realistic': 'Photorealistic, detailed portrait, professional photography, sharp focus',
                'anime': 'Anime style, vibrant colors, expressive eyes, detailed, studio Ghibli inspired',
                'watercolor': 'Watercolor painting, soft edges, artistic, dreamy, traditional art'
            };
            return prompts[style] || 'Detailed character portrait';
        }
        
        // Main AI Image Generation Function
        async function generateAIImage() {
            const prompt = document.getElementById('aiImagePrompt').value.trim();
            
            if (!prompt) {
                showNotification('Please describe your character first', 'warning');
                return;
            }
            
            // Show loading state
            const generateBtn = document.getElementById('generateAIBtn');
            const loadingDiv = document.getElementById('aiLoading');
            const resultsDiv = document.getElementById('aiResults');
            
            generateBtn.disabled = true;
            generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';
            loadingDiv.style.display = 'block';
            resultsDiv.innerHTML = '';
            
            try {
                // Enhanced prompt with style
                const enhancedPrompt = `${prompt}, ${getStylePrompt(selectedStyle)}, character portrait, full body, detailed, high quality`;
                
                // Use PartyRock API - Simulated for now
                // In production, you would make an actual API call to PartyRock
                await generateWithPartyRock(enhancedPrompt);
                
            } catch (error) {
                console.error('AI Generation Error:', error);
                showNotification('AI generation failed: ' + error.message, 'error');
                // Fallback to demo images
                await generateWithDemoAPI(enhancedPrompt);
            } finally {
                // Reset UI
                generateBtn.disabled = false;
                generateBtn.innerHTML = '<i class="fas fa-wand-magic-sparkles"></i> Generate Character Images';
                loadingDiv.style.display = 'none';
            }
        }
        
        // PartyRock API Implementation
        async function generateWithPartyRock(prompt) {
            try {
                showNotification('Using AI to create character images...', 'info');
                
                // Simulate API call - In production, replace with actual PartyRock API call
                // Example: You would use AWS Bedrock/PartyRock SDK or make HTTP requests
                
                // For now, we'll simulate with a delay and use demo images
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                // Generate unique seed for variety
                const seed = Date.now();
                const simulatedImages = [
                    `https://picsum.photos/seed/${seed}-party1/400/400`,
                    `https://picsum.photos/seed/${seed}-party2/400/400`,
                    `https://picsum.photos/seed/${seed}-party3/400/400`
                ];
                
                displayAIImages(simulatedImages, 'PartyRock AI');
                
            } catch (error) {
                throw new Error('AI service temporarily unavailable');
            }
        }
        
        // Demo API using Picsum for placeholder images
        async function generateWithDemoAPI(prompt) {
            showNotification('Using demo images...', 'info');
            
            // Simulate API call delay
            await new Promise(resolve => setTimeout(resolve, 1500));
            
            // Generate unique seed based on prompt
            const seed = hashCode(prompt);
            const simulatedImages = [
                `https://picsum.photos/seed/${seed}-a/400/400`,
                `https://picsum.photos/seed/${seed}-b/400/400`,
                `https://picsum.photos/seed/${seed}-c/400/400`
            ];
            
            displayAIImages(simulatedImages, 'Demo AI');
        }
        
        // Simple hash function
        function hashCode(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return Math.abs(hash);
        }
        
        // Display generated images
        function displayAIImages(imageUrls, source) {
            const resultsDiv = document.getElementById('aiResults');
            resultsDiv.innerHTML = '';
            
            imageUrls.forEach((url, index) => {
                const imageId = Date.now() + index;
                const imageCard = document.createElement('div');
                imageCard.className = 'ai-result-image';
                imageCard.innerHTML = `
                    <img src="${url}" alt="AI Generated Character" 
                         onerror="this.src='https://via.placeholder.com/400x400/333/fff?text=AI+Image'">
                    <div class="image-source-badge">${source}</div>
                    <div class="ai-image-actions">
                        <button class="ai-save-btn" onclick="saveAIImageToCharacter(${imageId}, '${url}')">
                            <i class="fas fa-save"></i> Use This
                        </button>
                        <button class="ai-regenerate-btn" onclick="regenerateSingleImage(${index})">
                            <i class="fas fa-redo"></i> Retry
                        </button>
                    </div>
                `;
                resultsDiv.appendChild(imageCard);
                
                // Store for later use
                aiGeneratedImages.push({
                    id: imageId,
                    url: url,
                    prompt: document.getElementById('aiImagePrompt').value,
                    style: selectedStyle,
                    source: source
                });
            });
            
            showNotification(`Generated ${imageUrls.length} character images!`, 'success');
        }
        
        // Save AI image to character
        function saveAIImageToCharacter(imageId, imageUrl) {
            // Initialize characterImages if not exists
            if (!characterImages) {
                characterImages = [];
            }
            
            // Add to character images array
            characterImages.push({
                id: imageId,
                characterId: Date.now(), // Will be updated when character is saved
                data: imageUrl,
                name: `AI Generated - ${document.getElementById('charName').value || 'Character'}`,
                source: 'ai'
            });
            
            // Update preview
            const preview = document.getElementById('charImagePreview');
            if (preview) {
                preview.innerHTML += `
                    <div class="image-preview">
                        <button class="remove-image" onclick="removeCharacterImage(${characterImages.length - 1})"></button>
                        <img src="${imageUrl}" alt="AI Generated">
                        <div style="font-size: 0.8rem; margin-top: 5px; text-align: center;">AI Generated</div>
                    </div>
                `;
            }
            
            showNotification('AI image added to character!', 'success');
        }
        
        // Regenerate single image
        async function regenerateSingleImage(index) {
            const prompt = document.getElementById('aiImagePrompt').value;
            if (!prompt) {
                showNotification('Please enter a prompt first', 'warning');
                return;
            }
            
            // Show loading for this specific image
            const resultsDiv = document.getElementById('aiResults');
            const imageCards = resultsDiv.querySelectorAll('.ai-result-image');
            if (imageCards[index]) {
                imageCards[index].innerHTML = `
                    <div style="padding: 40px; text-align: center;">
                        <div class="ai-loading-spinner" style="margin: 0 auto 10px;"></div>
                        <p>Regenerating...</p>
                    </div>
                `;
            }
            
            // Simulate regeneration
            await new Promise(resolve => setTimeout(resolve, 1500));
            
            // Generate new image
            const seed = Date.now() + index;
            const newImage = `https://picsum.photos/seed/${seed}-regenerated/400/400`;
            aiGeneratedImages[index].url = newImage;
            
            if (imageCards[index]) {
                imageCards[index].innerHTML = `
                    <img src="${newImage}" alt="AI Generated Character">
                    <div class="image-source-badge">AI</div>
                    <div class="ai-image-actions">
                        <button class="ai-save-btn" onclick="saveAIImageToCharacter(${aiGeneratedImages[index].id}, '${newImage}')">
                            <i class="fas fa-save"></i> Use This
                        </button>
                        <button class="ai-regenerate-btn" onclick="regenerateSingleImage(${index})">
                            <i class="fas fa-redo"></i> Retry
                        </button>
                    </div>
                `;
            }
            
            showNotification('Image regenerated!', 'success');
        }
        
        // =====================
        // ORIGINAL APP FUNCTIONS (Updated)
        // =====================
        
        // DOM elements
        const writingArea = document.getElementById('mainWritingArea');
        const notification = document.getElementById('notification');
        const tabBtns = document.querySelectorAll('.tab-btn');
        const tabContents = document.querySelectorAll('.tab-content');
        const currentTabTitle = document.getElementById('currentTabTitle');

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadFromStorage();
            setupTabs();
            setupEventListeners();
            updateStats();
            updateTabTitles();
            updateChapterSelect();
            
            // Auto-save every 30 seconds
            setInterval(saveEverything, 30000);
            
            // Setup quick jump
            document.getElementById('quickJump').addEventListener('change', function() {
                if (this.value) {
                    jumpToTab(this.value);
                    this.value = '';
                }
            });
            
            // Initialize AI style selection
            document.querySelector('.style-option[data-style="fantasy"]').classList.add('selected');
        });

        // Setup tabs
        function setupTabs() {
            tabBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    
                    // Update active tab
                    tabBtns.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    
                    tabContents.forEach(content => {
                        content.classList.remove('active');
                        if (content.id === `${tabId}-tab`) {
                            content.classList.add('active');
                        }
                    });
                    
                    // Update tab title
                    updateTabTitles();
                    
                    // Special tab handling
                    if (tabId === 'preview') {
                        generatePreview();
                    } else if (tabId === 'timeline') {
                        updateTimelineView();
                    } else if (tabId === 'writing') {
                        updateChapterSelect();
                    }
                });
            });
        }

        function updateTabTitles() {
            const activeTab = document.querySelector('.tab-btn.active');
            if (activeTab) {
                const tabName = activeTab.getAttribute('data-tab');
                const titles = {
                    'premise': 'Story Premise',
                    'world': 'World Building',
                    'characters': 'Characters',
                    'scenes': 'Important Scenes',
                    'timeline': 'Story Timeline',
                    'outline': 'Chapter Outline',
                    'notes': 'Writer\'s Notes',
                    'writing': 'Writing',
                    'preview': 'Codex Preview'
                };
                currentTabTitle.textContent = titles[tabName] || tabName;
            }
        }

        function jumpToTab(tabId) {
            if (tabId) {
                const tabBtn = document.querySelector(`[data-tab="${tabId}"]`);
                if (tabBtn) {
                    tabBtn.click();
                }
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            // Writing area
            writingArea.addEventListener('input', function() {
                const currentChapter = document.getElementById('writingChapter').value;
                if (currentChapter) {
                    codex.writing[currentChapter] = this.value;
                }
                updateStats();
            });
            
            // Metadata fields
            document.getElementById('novelTitle').addEventListener('input', function() {
                codex.metadata.title = this.value;
            });
            
            document.getElementById('authorName').addEventListener('input', function() {
                codex.metadata.author = this.value;
            });
            
            document.getElementById('genre').addEventListener('input', function() {
                codex.metadata.genre = this.value;
            });
            
            document.getElementById('targetAudience').addEventListener('input', function() {
                codex.metadata.audience = this.value;
            });
            
            // Timeline scale
            document.getElementById('timelineScale').addEventListener('change', function() {
                updateTimelineView();
            });
            
            // Writing chapter
            document.getElementById('writingChapter').addEventListener('change', function() {
                loadChapterForWriting();
            });
        }

        // Premise functions
        function savePremise() {
            codex.premise.theme = document.getElementById('premiseTheme').value;
            codex.premise.core = document.getElementById('premiseCore').value;
            codex.premise.characters = document.getElementById('premiseCharacters').value;
            codex.premise.world = document.getElementById('premiseWorld').value;
            showNotification('Premise saved!', 'success');
        }

        // World functions
        function saveWorldElement() {
            const worldId = Date.now();
            const worldElement = {
                id: worldId,
                category: document.getElementById('worldCategory').value,
                name: document.getElementById('worldName').value,
                description: document.getElementById('worldDescription').value,
                tags: document.getElementById('worldTags').value.split(',').map(tag => tag.trim()).filter(tag => tag)
            };
            
            // Add images if any
            const uploadedImages = worldImages.filter(img => img.elementId === worldId);
            if (uploadedImages.length > 0) {
                worldElement.images = uploadedImages;
            }
            
            codex.world.push(worldElement);
            updateWorldTab();
            
            // Clear form
            document.getElementById('worldName').value = '';
            document.getElementById('worldDescription').value = '';
            document.getElementById('worldTags').value = '';
            document.getElementById('worldImagePreview').innerHTML = '';
            
            showNotification('World element added!', 'success');
            updateStats();
        }

        function handleWorldImageUpload(event) {
            const files = event.target.files;
            const worldId = Date.now();
            
            for (let file of files) {
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const imageData = e.target.result;
                        worldImages.push({
                            id: Date.now(),
                            elementId: worldId,
                            data: imageData,
                            name: file.name
                        });
                        
                        // Update preview
                        const preview = document.getElementById('worldImagePreview');
                        preview.innerHTML += `
                            <div class="image-preview">
                                <button class="remove-image" onclick="removeWorldImage(${worldImages.length - 1})"></button>
                                <img src="${imageData}" alt="${file.name}">
                                <div style="font-size: 0.8rem; margin-top: 5px; text-align: center;">${file.name}</div>
                            </div>
                        `;
                    };
                    reader.readAsDataURL(file);
                }
            }
        }

        function removeWorldImage(index) {
            worldImages.splice(index, 1);
            const preview = document.getElementById('worldImagePreview');
            preview.innerHTML = '';
            worldImages.forEach((img, idx) => {
                preview.innerHTML += `
                    <div class="image-preview">
                        <button class="remove-image" onclick="removeWorldImage(${idx})"></button>
                        <img src="${img.data}" alt="${img.name}">
                        <div style="font-size: 0.8rem; margin-top: 5px; text-align: center;">${img.name}</div>
                    </div>
                `;
            });
        }

        function updateWorldTab() {
            const container = document.getElementById('worldContainer');
            container.innerHTML = '';
            
            codex.world.forEach(world => {
                const worldHTML = `
                    <div class="tool-card">
                        <button class="delete-btn" onclick="deleteWorldElement(${world.id})"></button>
                        <h3 class="tool-card-title">${world.name}</h3>
                        <div class="form-group">
                            <label>Category:</label>
                            <p>${world.category}</p>
                        </div>
                        <div class="form-group">
                            <label>Description:</label>
                            <p style="white-space: pre-wrap;">${world.description}</p>
                        </div>
                        ${world.tags && world.tags.length > 0 ? `
                        <div class="form-group">
                            <label>Tags:</label>
                            <div class="tag-container">
                                ${world.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}
                            </div>
                        </div>` : ''}
                        ${world.images && world.images.length > 0 ? `
                        <div class="form-group">
                            <label>Inspiration Images:</label>
                            <div class="image-preview-container">
                                ${world.images.map(img => `
                                    <div class="image-preview">
                                        <img src="${img.data}" alt="${img.name}">
                                    </div>
                                `).join('')}
                            </div>
                        </div>` : ''}
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', worldHTML);
            });
        }

        function deleteWorldElement(id) {
            codex.world = codex.world.filter(w => w.id !== id);
            updateWorldTab();
            updateStats();
            showNotification('World element deleted', 'info');
        }

        // Character functions
        function saveCharacter() {
            const charId = Date.now();
            const character = {
                id: charId,
                name: document.getElementById('charName').value,
                role: document.getElementById('charRole').value,
                appearance: document.getElementById('charAppearance').value,
                personality: document.getElementById('charPersonality').value,
                backstory: document.getElementById('charBackstory').value,
                arc: document.getElementById('charArc').value,
                tags: document.getElementById('charTags').value.split(',').map(tag => tag.trim()).filter(tag => tag),
                aiPrompt: document.getElementById('aiImagePrompt').value,
                aiStyle: selectedStyle
            };
            
            // Update characterId in character images
            if (characterImages) {
                characterImages.forEach(img => {
                    if (!img.characterId || img.characterId === charId) {
                        img.characterId = charId;
                    }
                });
                
                // Add all images (uploaded + AI generated)
                const charImages = characterImages.filter(img => img.characterId === charId);
                if (charImages.length > 0) {
                    character.images = charImages;
                }
            }
            
            codex.characters.push(character);
            updateCharactersTab();
            
            // Clear form but keep AI prompt for reference
            const aiPrompt = document.getElementById('aiImagePrompt').value;
            
            document.getElementById('charName').value = '';
            document.getElementById('charAppearance').value = '';
            document.getElementById('charPersonality').value = '';
            document.getElementById('charBackstory').value = '';
            document.getElementById('charArc').value = '';
            document.getElementById('charTags').value = '';
            document.getElementById('charImagePreview').innerHTML = '';
            document.getElementById('aiResults').innerHTML = '';
            
            // Keep AI prompt for next character
            document.getElementById('aiImagePrompt').value = aiPrompt;
            
            // Clear AI images for this character
            aiGeneratedImages = [];
            
            showNotification('Character created!', 'success');
            updateStats();
        }

        function handleCharImageUpload(event) {
            const files = event.target.files;
            const charId = Date.now();
            
            // Initialize characterImages if not exists
            if (!characterImages) {
                characterImages = [];
            }
            
            for (let file of files) {
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const imageData = e.target.result;
                        characterImages.push({
                            id: Date.now(),
                            characterId: charId,
                            data: imageData,
                            name: file.name,
                            source: 'upload'
                        });
                        
                        // Update preview
                        const preview = document.getElementById('charImagePreview');
                        if (preview) {
                            preview.innerHTML += `
                                <div class="image-preview">
                                    <button class="remove-image" onclick="removeCharacterImage(${characterImages.length - 1})"></button>
                                    <img src="${imageData}" alt="${file.name}">
                                    <div style="font-size: 0.8rem; margin-top: 5px; text-align: center;">${file.name}</div>
                                </div>
                            `;
                        }
                    };
                    reader.readAsDataURL(file);
                }
            }
        }

        function removeCharacterImage(index) {
            if (characterImages && characterImages[index]) {
                characterImages.splice(index, 1);
                const preview = document.getElementById('charImagePreview');
                if (preview) {
                    preview.innerHTML = '';
                    characterImages.forEach((img, idx) => {
                        if (img.source === 'upload') {
                            preview.innerHTML += `
                                <div class="image-preview">
                                    <button class="remove-image" onclick="removeCharacterImage(${idx})"></button>
                                    <img src="${img.data}" alt="${img.name}">
                                    <div style="font-size: 0.8rem; margin-top: 5px; text-align: center;">${img.name}</div>
                                </div>
                            `;
                        }
                    });
                }
            }
        }

        function updateCharactersTab() {
            const container = document.getElementById('charactersContainer');
            container.innerHTML = '';
            
            codex.characters.forEach(char => {
                const charHTML = `
                    <div class="tool-card">
                        <button class="delete-btn" onclick="deleteCharacter(${char.id})"></button>
                        <h3 class="tool-card-title">${char.name}</h3>
                        <div style="display: flex; justify-content: space-between; align-items: start; gap: 20px; flex-wrap: wrap;">
                            <div style="flex: 2; min-width: 300px;">
                                <div class="form-group">
                                    <label>Role:</label>
                                    <p>${char.role}</p>
                                </div>
                                <div class="form-group">
                                    <label>Appearance:</label>
                                    <p style="white-space: pre-wrap;">${char.appearance}</p>
                                </div>
                                ${char.aiPrompt ? `
                                <div class="form-group">
                                    <label>AI Prompt Used:</label>
                                    <p style="font-size: 0.9rem; color: var(--dark-gray); font-style: italic;">${char.aiPrompt}</p>
                                </div>` : ''}
                            </div>
                            ${char.images && char.images.length > 0 ? `
                            <div style="flex: 1; min-width: 200px;">
                                <label>Visual References:</label>
                                <div class="image-preview-container">
                                    ${char.images.map(img => `
                                        <div class="image-preview">
                                            <img src="${img.data}" alt="${img.name}">
                                            ${img.source === 'ai' ? '<div style="font-size: 0.7rem; text-align: center; background: #ff6b6b; color: white; padding: 2px;">AI</div>' : ''}
                                        </div>
                                    `).join('')}
                                </div>
                            </div>` : ''}
                        </div>
                        <div class="form-group">
                            <label>Personality:</label>
                            <p style="white-space: pre-wrap;">${char.personality}</p>
                        </div>
                        <div class="form-group">
                            <label>Backstory:</label>
                            <p style="white-space: pre-wrap;">${char.backstory}</p>
                        </div>
                        <div class="form-group">
                            <label>Character Arc:</label>
                            <p style="white-space: pre-wrap;">${char.arc}</p>
                        </div>
                        ${char.tags && char.tags.length > 0 ? `
                        <div class="form-group">
                            <label>Tags:</label>
                            <div class="tag-container">
                                ${char.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}
                            </div>
                        </div>` : ''}
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', charHTML);
            });
        }

        function deleteCharacter(id) {
            codex.characters = codex.characters.filter(c => c.id !== id);
            updateCharactersTab();
            updateStats();
            showNotification('Character deleted', 'info');
        }

        // Scene functions
        function saveScene() {
            const sceneId = Date.now();
            const scene = {
                id: sceneId,
                title: document.getElementById('sceneTitle').value,
                type: document.getElementById('sceneType').value,
                characters: document.getElementById('sceneCharacters').value.split(',').map(c => c.trim()).filter(c => c),
                location: document.getElementById('sceneLocation').value,
                description: document.getElementById('sceneDescription').value,
                impact: document.getElementById('sceneImpact').value,
                timelinePosition: null
            };
            
            codex.scenes.push(scene);
            updateScenesTab();
            updateScenesForTimeline();
            
            // Clear form
            document.getElementById('sceneTitle').value = '';
            document.getElementById('sceneCharacters').value = '';
            document.getElementById('sceneLocation').value = '';
            document.getElementById('sceneDescription').value = '';
            document.getElementById('sceneImpact').value = '';
            
            showNotification('Scene added!', 'success');
            updateStats();
        }

        function updateScenesTab() {
            const container = document.getElementById('scenesContainer');
            container.innerHTML = '';
            
            codex.scenes.forEach(scene => {
                const sceneHTML = `
                    <div class="outline-card" draggable="true" ondragstart="dragScene(event, ${scene.id})" id="scene-${scene.id}">
                        <div class="outline-number">${scene.type.toUpperCase()}</div>
                        <h4 style="font-family: 'Homemade Apple', cursive; font-size: 1.3rem; margin-bottom: 10px;">${scene.title}</h4>
                        <p><strong>Characters:</strong> ${scene.characters.join(', ')}</p>
                        <p><strong>Location:</strong> ${scene.location}</p>
                        <p style="margin-top: 10px; white-space: pre-wrap;">${scene.description.substring(0, 150)}${scene.description.length > 150 ? '...' : ''}</p>
                        <button class="delete-btn" onclick="deleteScene(${scene.id})" style="top: 5px; right: 5px;"></button>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', sceneHTML);
            });
        }

        function updateScenesForTimeline() {
            const container = document.getElementById('scenesForTimeline');
            container.innerHTML = '';
            
            codex.scenes.forEach(scene => {
                const sceneHTML = `
                    <div class="outline-card" draggable="true" ondragstart="dragScene(event, ${scene.id})" id="timeline-scene-${scene.id}">
                        <div class="outline-number">${scene.type.toUpperCase()}</div>
                        <h4 style="font-family: 'Homemade Apple', cursive; font-size: 1.2rem; margin-bottom: 5px;">${scene.title}</h4>
                        <p style="font-size: 0.9rem;">${scene.characters.join(', ')} - ${scene.location}</p>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', sceneHTML);
            });
        }

        function dragScene(event, sceneId) {
            event.dataTransfer.setData('sceneId', sceneId);
        }

        function deleteScene(id) {
            codex.scenes = codex.scenes.filter(s => s.id !== id);
            updateScenesTab();
            updateScenesForTimeline();
            updateStats();
            showNotification('Scene deleted', 'info');
        }

        // Timeline functions
        function updateTimelineView() {
            const container = document.getElementById('timelineVisual');
            const scale = document.getElementById('timelineScale').value;
            
            container.innerHTML = '';
            
            // Allow drop
            container.ondragover = function(event) {
                event.preventDefault();
            };
            
            container.ondrop = function(event) {
                event.preventDefault();
                const sceneId = event.dataTransfer.getData('sceneId');
                if (sceneId) {
                    addSceneToTimeline(parseInt(sceneId), scale);
                }
            };
            
            // Display existing timeline events
            codex.timeline.sort((a, b) => a.position - b.position);
            
            codex.timeline.forEach(event => {
                const scene = codex.scenes.find(s => s.id === event.sceneId);
                if (scene) {
                    const eventHTML = `
                        <div class="timeline-event">
                            <div class="timeline-dot"></div>
                            <div class="timeline-content">
                                <h4 style="font-family: 'Homemade Apple', cursive; margin-bottom: 5px;">${scene.title}</h4>
                                <p><strong>Position:</strong> ${scale === 'chapters' ? `Chapter ${event.position}` : scale === 'acts' ? `Act ${event.position}` : `Time ${event.position}`}</p>
                                <p style="white-space: pre-wrap; font-size: 0.9rem;">${scene.description.substring(0, 100)}${scene.description.length > 100 ? '...' : ''}</p>
                                <button class="delete-btn" onclick="removeFromTimeline(${event.id})" style="position: static; display: inline-block; margin-top: 5px;">Remove</button>
                            </div>
                        </div>
                    `;
                    container.insertAdjacentHTML('beforeend', eventHTML);
                }
            });
        }

        function addSceneToTimeline(sceneId, scale) {
            const position = prompt(`Enter position for this scene (e.g., ${scale === 'chapters' ? 'chapter number' : scale === 'acts' ? 'act number' : 'time period'}):`);
            if (position) {
                const timelineId = Date.now();
                codex.timeline.push({
                    id: timelineId,
                    sceneId: sceneId,
                    scale: scale,
                    position: position
                });
                updateTimelineView();
                showNotification('Scene added to timeline', 'success');
            }
        }

        function removeFromTimeline(timelineId) {
            codex.timeline = codex.timeline.filter(t => t.id !== timelineId);
            updateTimelineView();
            showNotification('Removed from timeline', 'info');
        }

        // Outline functions
        function saveChapterOutline() {
            const outlineId = Date.now();
            const outline = {
                id: outlineId,
                number: document.getElementById('outlineChapterNumber').value,
                title: document.getElementById('outlineChapterTitle').value,
                pov: document.getElementById('outlinePOV').value,
                synopsis: document.getElementById('outlineSynopsis').value,
                purpose: document.getElementById('outlinePurpose').value
            };
            
            codex.outline.push(outline);
            updateOutlineTab();
            updateChapterSelect();
            
            // Clear form
            document.getElementById('outlineChapterNumber').value = '';
            document.getElementById('outlineChapterTitle').value = '';
            document.getElementById('outlinePOV').value = '';
            document.getElementById('outlineSynopsis').value = '';
            document.getElementById('outlinePurpose').value = '';
            
            showNotification('Chapter added to outline!', 'success');
            updateStats();
        }

        function updateOutlineTab() {
            const container = document.getElementById('outlineContainer');
            container.innerHTML = '';
            
            // Sort by chapter number
            const sorted = [...codex.outline].sort((a, b) => {
                const aNum = parseInt(a.number.replace(/\D/g, '')) || 0;
                const bNum = parseInt(b.number.replace(/\D/g, '')) || 0;
                return aNum - bNum;
            });
            
            sorted.forEach(chapter => {
                const chapterHTML = `
                    <div class="tool-card">
                        <button class="delete-btn" onclick="deleteChapterOutline(${chapter.id})"></button>
                        <h3 class="tool-card-title">${chapter.number}: ${chapter.title}</h3>
                        <div class="form-group">
                            <label>POV Character:</label>
                            <p>${chapter.pov}</p>
                        </div>
                        <div class="form-group">
                            <label>Synopsis:</label>
                            <p style="white-space: pre-wrap;">${chapter.synopsis}</p>
                        </div>
                        <div class="form-group">
                            <label>Purpose:</label>
                            <p style="white-space: pre-wrap;">${chapter.purpose}</p>
                        </div>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', chapterHTML);
            });
        }

        function deleteChapterOutline(id) {
            codex.outline = codex.outline.filter(o => o.id !== id);
            updateOutlineTab();
            updateChapterSelect();
            updateStats();
            showNotification('Chapter outline deleted', 'info');
        }

        // Notes functions
        function saveNote() {
            const noteId = Date.now();
            const note = {
                id: noteId,
                title: document.getElementById('noteTitle').value,
                category: document.getElementById('noteCategory').value,
                content: document.getElementById('noteContent').value,
                created: new Date().toISOString()
            };
            
            codex.notes.push(note);
            updateNotesTab();
            
            // Clear form
            document.getElementById('noteTitle').value = '';
            document.getElementById('noteContent').value = '';
            
            showNotification('Note saved!', 'success');
            updateStats();
        }

        function updateNotesTab() {
            const container = document.getElementById('notesContainer');
            container.innerHTML = '';
            
            codex.notes.forEach(note => {
                const noteHTML = `
                    <div class="tool-card">
                        <button class="delete-btn" onclick="deleteNote(${note.id})"></button>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <h3 class="tool-card-title">${note.title}</h3>
                            <span style="background: var(--black); color: white; padding: 2px 8px; border-radius: 0; font-size: 0.9rem; font-family: 'Shadows Into Light', cursive;">
                                ${note.category}
                            </span>
                        </div>
                        <div class="form-group">
                            <p style="white-space: pre-wrap;">${note.content}</p>
                        </div>
                        <div style="font-size: 0.8rem; color: var(--dark-gray); margin-top: 10px;">
                            Created: ${new Date(note.created).toLocaleDateString()}
                        </div>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', noteHTML);
            });
        }

        function deleteNote(id) {
            codex.notes = codex.notes.filter(n => n.id !== id);
            updateNotesTab();
            updateStats();
            showNotification('Note deleted', 'info');
        }

        // Writing functions
        function updateChapterSelect() {
            const select = document.getElementById('writingChapter');
            select.innerHTML = '<option value="">Select a chapter to write...</option>';
            
            codex.outline.forEach(chapter => {
                const option = document.createElement('option');
                option.value = chapter.number;
                option.textContent = `${chapter.number}: ${chapter.title}`;
                select.appendChild(option);
            });
            
            // Add option for new chapter
            const newOption = document.createElement('option');
            newOption.value = 'new';
            newOption.textContent = '+ Create New Chapter';
            select.appendChild(newOption);
        }

        function loadChapterForWriting() {
            const chapterNum = document.getElementById('writingChapter').value;
            if (chapterNum === 'new') {
                const newNum = prompt('Enter new chapter number/title:');
                if (newNum) {
                    const newChapter = {
                        number: newNum,
                        title: 'New Chapter',
                        synopsis: '',
                        purpose: ''
                    };
                    codex.outline.push(newChapter);
                    updateChapterSelect();
                    document.getElementById('writingChapter').value = newNum;
                    writingArea.value = codex.writing[newNum] || '';
                }
            } else if (chapterNum) {
                writingArea.value = codex.writing[chapterNum] || '';
            } else {
                writingArea.value = '';
            }
            updateStats();
        }

        // Update stats
        function updateStats() {
            // Count total words in writing
            let totalWords = 0;
            let totalChars = 0;
            
            for (const chapter in codex.writing) {
                const text = codex.writing[chapter] || '';
                totalWords += text.trim() === '' ? 0 : text.trim().split(/\s+/).length;
                totalChars += text.length;
            }
            
            // Current writing area
            const currentText = writingArea.value;
            document.getElementById('wordCount').textContent = currentText.trim() === '' ? 0 : currentText.trim().split(/\s+/).length;
            document.getElementById('charCount').textContent = currentText.length;
            
            // Update stats
            document.getElementById('statWords').textContent = totalWords;
            document.getElementById('statCharacters').textContent = codex.characters.length;
            document.getElementById('statScenes').textContent = codex.scenes.length;
            document.getElementById('statChapters').textContent = codex.outline.length;
            document.getElementById('statWorld').textContent = codex.world.length;
            document.getElementById('statNotes').textContent = codex.notes.length;
        }

        // Generate preview
        function generatePreview() {
            const container = document.getElementById('previewContainer');
            
            let previewHTML = `
                <div style="padding: 30px; background: var(--white); border: 2px solid var(--black); font-family: 'Caveat', cursive; font-size: 1.2rem; line-height: 1.8;">
                    <h1 style="text-align: center; font-family: 'Homemade Apple', cursive; font-size: 2.5rem; margin-bottom: 20px; letter-spacing: 2px;">
                        ${codex.metadata.title || 'Untitled Manuscript'}
                    </h1>
                    
                    <div style="text-align: center; margin-bottom: 30px; border-bottom: 1px solid var(--border); padding-bottom: 20px;">
                        <p><strong>Author:</strong> ${codex.metadata.author || 'Unknown'}</p>
                        <p><strong>Genre:</strong> ${codex.metadata.genre || 'Not specified'}</p>
                        <p><strong>Target Audience:</strong> ${codex.metadata.audience || 'Not specified'}</p>
                        <p><strong>Last Modified:</strong> ${new Date(codex.metadata.modified).toLocaleString()}</p>
                    </div>
                    
                    <div style="margin-bottom: 30px;">
                        <h2 style="font-family: 'Homemade Apple', cursive; font-size: 1.8rem; border-bottom: 1px solid var(--border); padding-bottom: 8px; margin-bottom: 15px;">Story Premise</h2>
                        <p><strong>Theme/Logline:</strong> ${codex.premise.theme || 'Not specified'}</p>
                        <p><strong>Core Premise:</strong> ${codex.premise.core || 'Not specified'}</p>
                        <p><strong>Characters in Premise:</strong> ${codex.premise.characters || 'Not specified'}</p>
                        <p><strong>World Connection:</strong> ${codex.premise.world || 'Not specified'}</p>
                    </div>
            `;
            
            // Characters
            if (codex.characters.length > 0) {
                previewHTML += `
                    <div style="margin-bottom: 30px;">
                        <h2 style="font-family: 'Homemade Apple', cursive; font-size: 1.8rem; border-bottom: 1px solid var(--border); padding-bottom: 8px; margin-bottom: 15px;">Characters (${codex.characters.length})</h2>
                        ${codex.characters.map(char => `
                            <div style="margin-bottom: 20px; padding: 15px; border: 1px solid var(--border);">
                                <h3 style="font-family: 'Homemade Apple', cursive; font-size: 1.5rem; margin-bottom: 10px;">${char.name} - ${char.role}</h3>
                                <p><strong>Appearance:</strong> ${char.appearance || 'Not specified'}</p>
                                <p><strong>Personality:</strong> ${char.personality || 'Not specified'}</p>
                                <p><strong>Backstory:</strong> ${char.backstory || 'Not specified'}</p>
                                <p><strong>Character Arc:</strong> ${char.arc || 'Not specified'}</p>
                                ${char.aiPrompt ? `<p><em>AI Generated with: ${char.aiStyle || 'AI'}</em></p>` : ''}
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            // World Building
            if (codex.world.length > 0) {
                previewHTML += `
                    <div style="margin-bottom: 30px;">
                        <h2 style="font-family: 'Homemade Apple', cursive; font-size: 1.8rem; border-bottom: 1px solid var(--border); padding-bottom: 8px; margin-bottom: 15px;">World Building (${codex.world.length})</h2>
                        ${codex.world.map(world => `
                            <div style="margin-bottom: 20px; padding: 15px; border: 1px solid var(--border);">
                                <h3 style="font-family: 'Homemade Apple', cursive; font-size: 1.5rem; margin-bottom: 10px;">${world.name} - ${world.category}</h3>
                                <p>${world.description || 'No description'}</p>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            // Scenes
            if (codex.scenes.length > 0) {
                previewHTML += `
                    <div style="margin-bottom: 30px;">
                        <h2 style="font-family: 'Homemade Apple', cursive; font-size: 1.8rem; border-bottom: 1px solid var(--border); padding-bottom: 8px; margin-bottom: 15px;">Important Scenes (${codex.scenes.length})</h2>
                        ${codex.scenes.map(scene => `
                            <div style="margin-bottom: 20px; padding: 15px; border: 1px solid var(--border);">
                                <h3 style="font-family: 'Homemade Apple', cursive; font-size: 1.5rem; margin-bottom: 10px;">${scene.title} - ${scene.type}</h3>
                                <p><strong>Characters:</strong> ${scene.characters.join(', ') || 'None'}</p>
                                <p><strong>Location:</strong> ${scene.location || 'Not specified'}</p>
                                <p><strong>Description:</strong> ${scene.description || 'No description'}</p>
                                <p><strong>Impact:</strong> ${scene.impact || 'Not specified'}</p>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            // Outline
            if (codex.outline.length > 0) {
                previewHTML += `
                    <div style="margin-bottom: 30px;">
                        <h2 style="font-family: 'Homemade Apple', cursive; font-size: 1.8rem; border-bottom: 1px solid var(--border); padding-bottom: 8px; margin-bottom: 15px;">Chapter Outline (${codex.outline.length})</h2>
                        ${codex.outline.map(chapter => `
                            <div style="margin-bottom: 20px; padding: 15px; border: 1px solid var(--border);">
                                <h3 style="font-family: 'Homemade Apple', cursive; font-size: 1.5rem; margin-bottom: 10px;">${chapter.number}: ${chapter.title}</h3>
                                <p><strong>POV:</strong> ${chapter.pov || 'Not specified'}</p>
                                <p><strong>Synopsis:</strong> ${chapter.synopsis || 'No synopsis'}</p>
                                <p><strong>Purpose:</strong> ${chapter.purpose || 'Not specified'}</p>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            // Notes
            if (codex.notes.length > 0) {
                previewHTML += `
                    <div style="margin-bottom: 30px;">
                        <h2 style="font-family: 'Homemade Apple', cursive; font-size: 1.8rem; border-bottom: 1px solid var(--border); padding-bottom: 8px; margin-bottom: 15px;">Writer's Notes (${codex.notes.length})</h2>
                        ${codex.notes.map(note => `
                            <div style="margin-bottom: 15px; padding: 10px; border: 1px solid var(--border);">
                                <h4 style="font-family: 'Homemade Apple', cursive; font-size: 1.3rem; margin-bottom: 5px;">${note.title} <span style="font-size: 0.9rem; background: var(--light-gray); padding: 2px 6px;">${note.category}</span></h4>
                                <p>${note.content || 'No content'}</p>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            // Writing
            let totalWritingWords = 0;
            let writingChapters = 0;
            
            for (const chapter in codex.writing) {
                if (codex.writing[chapter] && codex.writing[chapter].trim()) {
                    totalWritingWords += codex.writing[chapter].trim().split(/\s+/).length;
                    writingChapters++;
                }
            }
            
            if (writingChapters > 0) {
                previewHTML += `
                    <div style="margin-bottom: 30px;">
                        <h2 style="font-family: 'Homemade Apple', cursive; font-size: 1.8rem; border-bottom: 1px solid var(--border); padding-bottom: 8px; margin-bottom: 15px;">Written Content</h2>
                        <p><strong>Total Written Words:</strong> ${totalWritingWords} across ${writingChapters} chapter(s)</p>
                        ${Object.entries(codex.writing).filter(([_, text]) => text && text.trim()).map(([chapter, text]) => `
                            <div style="margin-bottom: 20px; padding: 15px; border: 1px solid var(--border);">
                                <h3 style="font-family: 'Homemade Apple', cursive; font-size: 1.5rem; margin-bottom: 10px;">Chapter: ${chapter}</h3>
                                <div style="white-space: pre-wrap; font-family: 'Caveat', cursive;">${text.substring(0, 300)}${text.length > 300 ? '... (continued in full PDF)' : ''}</div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            previewHTML += `
                <div style="text-align: center; margin-top: 40px; padding-top: 20px; border-top: 2px solid var(--border);">
                    <p><strong>Total Planning Elements:</strong> ${codex.characters.length + codex.world.length + codex.scenes.length + codex.outline.length + codex.notes.length}</p>
                    <p><strong>AI Features:</strong> AI-powered character image generation</p>
                    <p><em>Click "Generate Aesthetic Codex" to export everything in a beautiful handwritten-style PDF.</em></p>
                </div>
            </div>`;
            
            container.innerHTML = previewHTML;
        }

        // Complete PDF Generation
        function generateAestheticPDF() {
            showNotification('Creating beautiful handwritten Codex PDF...', 'info');
            
            saveEverything();
            
            setTimeout(() => {
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                
                const pageWidth = pdf.internal.pageSize.width;
                const margin = 20;
                let yPos = margin;
                const lineHeight = 6.5;
                
                // Title Page
                pdf.setFont("times", "italic");
                pdf.setFontSize(28);
                pdf.setTextColor(0, 0, 0);
                const title = codex.metadata.title || "Untitled Manuscript";
                pdf.text(title, pageWidth / 2, 100, { align: 'center' });
                
                pdf.setFontSize(18);
                pdf.setFont("times", "normal");
                pdf.text(`by ${codex.metadata.author || "Anonymous"}`, pageWidth / 2, 120, { align: 'center' });
                
                pdf.setFontSize(12);
                pdf.text(`Genre: ${codex.metadata.genre || "Not specified"}`, pageWidth / 2, 145, { align: 'center' });
                pdf.text(`Created with Quill & Codex`, pageWidth / 2, 155, { align: 'center' });
                pdf.text(`Generated: ${new Date().toLocaleDateString()}`, pageWidth / 2, 165, { align: 'center' });
                
                // Add new page for content
                pdf.addPage();
                yPos = margin;
                
                // Table of Contents
                pdf.setFont("times", "bolditalic");
                pdf.setFontSize(22);
                pdf.text("Table of Contents", pageWidth / 2, yPos, { align: 'center' });
                yPos += 20;
                
                pdf.setFont("times", "normal");
                pdf.setFontSize(13);
                
                let tocY = yPos;
                let tocPage = 3;
                
                // Add all sections
                const sections = [];
                
                if (codex.premise.theme || codex.premise.core) {
                    sections.push({ title: "I. Story Premise", page: tocPage });
                    tocPage++;
                }
                
                if (codex.characters.length > 0) {
                    sections.push({ title: `II. Characters (${codex.characters.length})`, page: tocPage });
                    tocPage += Math.ceil(codex.characters.length / 3);
                }
                
                if (codex.world.length > 0) {
                    sections.push({ title: `III. World Building (${codex.world.length})`, page: tocPage });
                    tocPage += Math.ceil(codex.world.length / 4);
                }
                
                if (codex.scenes.length > 0) {
                    sections.push({ title: `IV. Important Scenes (${codex.scenes.length})`, page: tocPage });
                    tocPage += Math.ceil(codex.scenes.length / 3);
                }
                
                if (codex.outline.length > 0) {
                    sections.push({ title: `V. Chapter Outline (${codex.outline.length})`, page: tocPage });
                    tocPage += Math.ceil(codex.outline.length / 2);
                }
                
                if (codex.notes.length > 0) {
                    sections.push({ title: `VI. Writer's Notes (${codex.notes.length})`, page: tocPage });
                    tocPage += Math.ceil(codex.notes.length / 4);
                }
                
                const writtenChapters = Object.entries(codex.writing).filter(([_, text]) => text && text.trim());
                if (writtenChapters.length > 0) {
                    sections.push({ title: `VII. Written Content (${writtenChapters.length} chapters)`, page: tocPage });
                }
                
                sections.forEach(section => {
                    pdf.text(section.title, margin, tocY);
                    pdf.text(section.page.toString(), pageWidth - margin, tocY, { align: 'right' });
                    tocY += lineHeight + 2;
                });
                
                // Save the PDF
                const fileName = `${codex.metadata.title.replace(/[^a-z0-9]/gi, '_') || 'novel'}_Codex.pdf`;
                pdf.save(fileName);
                showNotification('Beautiful handwritten Codex PDF generated!', 'success');
            }, 1000);
        }

        // Save/Load functions
        function saveEverything() {
            // Update metadata
            codex.metadata.title = document.getElementById('novelTitle').value;
            codex.metadata.author = document.getElementById('authorName').value;
            codex.metadata.genre = document.getElementById('genre').value;
            codex.metadata.audience = document.getElementById('targetAudience').value;
            codex.metadata.modified = new Date().toISOString();
            
            // Save writing
            const currentChapter = document.getElementById('writingChapter').value;
            if (currentChapter) {
                codex.writing[currentChapter] = writingArea.value;
            }
            
            // Save to localStorage
            try {
                const dataToSave = {
                    ...codex,
                    worldImages: worldImages,
                    characterImages: characterImages,
                    aiGeneratedImages: aiGeneratedImages,
                    selectedStyle: selectedStyle
                };
                localStorage.setItem('quillCodexData', JSON.stringify(dataToSave));
                showNotification('Complete Codex saved!', 'success');
            } catch (e) {
                showNotification('Error saving data. Try exporting as JSON instead.', 'error');
            }
        }

        function loadEverything() {
            const saved = localStorage.getItem('quillCodexData');
            if (saved) {
                try {
                    const loadedData = JSON.parse(saved);
                    codex = loadedData;
                    
                    // Load images and AI settings if they exist
                    worldImages = loadedData.worldImages || [];
                    characterImages = loadedData.characterImages || [];
                    aiGeneratedImages = loadedData.aiGeneratedImages || [];
                    selectedStyle = loadedData.selectedStyle || "fantasy";
                    
                    // Restore UI
                    document.getElementById('novelTitle').value = codex.metadata.title;
                    document.getElementById('authorName').value = codex.metadata.author;
                    document.getElementById('genre').value = codex.metadata.genre;
                    document.getElementById('targetAudience').value = codex.metadata.audience;
                    
                    document.getElementById('premiseTheme').value = codex.premise.theme;
                    document.getElementById('premiseCore').value = codex.premise.core;
                    document.getElementById('premiseCharacters').value = codex.premise.characters;
                    document.getElementById('premiseWorld').value = codex.premise.world;
                    
                    // Restore AI selection
                    document.querySelectorAll('.style-option').forEach(opt => {
                        opt.classList.remove('selected');
                        if (opt.getAttribute('data-style') === selectedStyle) {
                            opt.classList.add('selected');
                        }
                    });
                    
                    // Update all tabs
                    updateWorldTab();
                    updateCharactersTab();
                    updateScenesTab();
                    updateScenesForTimeline();
                    updateOutlineTab();
                    updateNotesTab();
                    updateChapterSelect();
                    
                    // Load current writing if any
                    const currentChapter = document.getElementById('writingChapter').value;
                    if (currentChapter) {
                        writingArea.value = codex.writing[currentChapter] || '';
                    }
                    
                    updateStats();
                    showNotification('Codex loaded successfully!', 'success');
                } catch (e) {
                    console.error('Error loading saved data:', e);
                    showNotification('Error loading saved data', 'error');
                }
            } else {
                showNotification('No saved Codex found.', 'info');
            }
        }

        function exportToJSON() {
            saveEverything();
            
            const dataStr = JSON.stringify(codex, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `${codex.metadata.title.replace(/[^a-z0-9]/gi, '_') || 'quill_codex'}_export.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            
            showNotification('Codex exported as JSON!', 'success');
        }

        function importFromJSON() {
            document.getElementById('jsonImport').click();
        }

        document.getElementById('jsonImport').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        if (confirm('Import will overwrite current data. Continue?')) {
                            codex = importedData;
                            loadEverything();
                            showNotification('Codex imported successfully!', 'success');
                        }
                    } catch (error) {
                        showNotification('Error importing JSON file', 'error');
                    }
                };
                reader.readAsText(file);
            }
        });

        function clearEverything() {
            if (confirm('Are you sure you want to clear EVERYTHING? This cannot be undone!')) {
                codex = {
                    premise: {
                        theme: '',
                        core: '',
                        characters: '',
                        world: ''
                    },
                    world: [],
                    characters: [],
                    scenes: [],
                    timeline: [],
                    outline: [],
                    notes: [],
                    writing: {},
                    metadata: {
                        title: 'Untitled Manuscript',
                        author: '',
                        genre: '',
                        audience: '',
                        created: new Date().toISOString(),
                        modified: new Date().toISOString()
                    }
                };
                
                worldImages = [];
                characterImages = [];
                aiGeneratedImages = [];
                selectedStyle = "fantasy";
                
                // Clear all form fields
                document.getElementById('novelTitle').value = 'Untitled Manuscript';
                document.getElementById('authorName').value = '';
                document.getElementById('genre').value = '';
                document.getElementById('targetAudience').value = '';
                
                document.getElementById('premiseTheme').value = '';
                document.getElementById('premiseCore').value = '';
                document.getElementById('premiseCharacters').value = '';
                document.getElementById('premiseWorld').value = '';
                
                document.getElementById('worldName').value = '';
                document.getElementById('worldDescription').value = '';
                document.getElementById('worldTags').value = '';
                document.getElementById('worldImagePreview').innerHTML = '';
                
                document.getElementById('charName').value = '';
                document.getElementById('charAppearance').value = '';
                document.getElementById('charPersonality').value = '';
                document.getElementById('charBackstory').value = '';
                document.getElementById('charArc').value = '';
                document.getElementById('charTags').value = '';
                document.getElementById('charImagePreview').innerHTML = '';
                document.getElementById('aiImagePrompt').value = '';
                document.getElementById('aiResults').innerHTML = '';
                
                document.getElementById('sceneTitle').value = '';
                document.getElementById('sceneCharacters').value = '';
                document.getElementById('sceneLocation').value = '';
                document.getElementById('sceneDescription').value = '';
                document.getElementById('sceneImpact').value = '';
                
                document.getElementById('outlineChapterNumber').value = '';
                document.getElementById('outlineChapterTitle').value = '';
                document.getElementById('outlinePOV').value = '';
                document.getElementById('outlineSynopsis').value = '';
                document.getElementById('outlinePurpose').value = '';
                
                document.getElementById('noteTitle').value = '';
                document.getElementById('noteContent').value = '';
                
                writingArea.value = '';
                document.getElementById('writingChapter').innerHTML = '<option value="">Select a chapter to write...</option>';
                
                // Reset AI selection
                document.querySelectorAll('.style-option').forEach(opt => opt.classList.remove('selected'));
                document.querySelector('.style-option[data-style="fantasy"]').classList.add('selected');
                
                // Clear containers
                document.getElementById('worldContainer').innerHTML = '';
                document.getElementById('charactersContainer').innerHTML = '';
                document.getElementById('scenesContainer').innerHTML = '';
                document.getElementById('scenesForTimeline').innerHTML = '';
                document.getElementById('timelineVisual').innerHTML = '';
                document.getElementById('outlineContainer').innerHTML = '';
                document.getElementById('notesContainer').innerHTML = '';
                document.getElementById('previewContainer').innerHTML = '';
                
                localStorage.removeItem('quillCodexData');
                updateStats();
                showNotification('All data cleared!', 'success');
            }
        }

        function loadFromStorage() {
            const saved = localStorage.getItem('quillCodexData');
            if (saved) {
                try {
                    const loadedData = JSON.parse(saved);
                    codex = loadedData;
                    
                    // Set form values
                    document.getElementById('novelTitle').value = codex.metadata.title;
                    document.getElementById('authorName').value = codex.metadata.author;
                    document.getElementById('genre').value = codex.metadata.genre;
                    document.getElementById('targetAudience').value = codex.metadata.audience;
                    
                    document.getElementById('premiseTheme').value = codex.premise.theme;
                    document.getElementById('premiseCore').value = codex.premise.core;
                    document.getElementById('premiseCharacters').value = codex.premise.characters;
                    document.getElementById('premiseWorld').value = codex.premise.world;
                    
                    // Load images and AI settings
                    worldImages = loadedData.worldImages || [];
                    characterImages = loadedData.characterImages || [];
                    aiGeneratedImages = loadedData.aiGeneratedImages || [];
                    selectedStyle = loadedData.selectedStyle || "fantasy";
                    
                    // Set AI selection
                    document.querySelectorAll('.style-option').forEach(opt => {
                        opt.classList.remove('selected');
                        if (opt.getAttribute('data-style') === selectedStyle) {
                            opt.classList.add('selected');
                        }
                    });
                    
                    // Update tabs
                    updateWorldTab();
                    updateCharactersTab();
                    updateScenesTab();
                    updateScenesForTimeline();
                    updateOutlineTab();
                    updateNotesTab();
                    updateChapterSelect();
                    
                } catch (e) {
                    console.error('Error loading saved data:', e);
                }
            }
        }

        function showNotification(message, type = 'info') {
            notification.textContent = message;
            notification.style.display = 'block';
            notification.style.borderColor = type === 'success' ? 'var(--black)' : 
                                          type === 'warning' ? '#ff9800' : 
                                          type === 'error' ? '#f44336' : 'var(--dark-gray)';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }
    </script>
</body>
</html>

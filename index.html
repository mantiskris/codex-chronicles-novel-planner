<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Novel Planner | Hobonichi Style</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Caveat:wght@400;500;600;700&family=Dancing+Script:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            --pastel-pink: #F8D7DA;
            --soft-cream: #FFF9F5;
            --light-gray: #F0F0F0;
            --muted-charcoal: #5A5A5A;
            --pastel-mint: #C1E1D2;
            --pastel-lavender: #D4C4E6;
            --pastel-peach: #FFD8BE;
            --pastel-blue: #B5E0F9;
            --grid-line: rgba(248, 215, 218, 0.3);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--soft-cream);
            color: var(--muted-charcoal);
            line-height: 1.6;
            min-height: 100vh;
            background-image: 
                repeating-linear-gradient(0deg, transparent, transparent 29px, var(--grid-line) 29px, var(--grid-line) 30px);
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            display: grid;
            grid-template-columns: 280px 1fr;
            gap: 25px;
            min-height: 100vh;
        }
        
        /* Header */
        .header {
            grid-column: 1 / -1;
            text-align: center;
            padding: 30px 20px;
            margin-bottom: 20px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            border: 1px solid var(--pastel-pink);
            position: relative;
            overflow: hidden;
        }
        
        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--pastel-pink), var(--pastel-lavender), var(--pastel-mint));
        }
        
        .logo-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin-bottom: 15px;
        }
        
        .angel-logo {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, var(--pastel-pink), var(--pastel-lavender));
            -webkit-mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cpath d='M50 20c10-10 30-10 40 0 5 10 5 20 0 30-5 10-20 20-40 30-20-10-35-20-40-30-5-10-5-20 0-30 10-10 30-10 40 0z'/%3E%3Cpath d='M30 40c-5 5-5 15 0 20 5 5 15 5 20 0 5 5 15 5 20 0 5-5 5-15 0-20-5-5-15-5-20 0-5-5-15-5-20 0z'/%3E%3Cpath d='M35 35l-5 15M65 35l5 15M50 20v-5M40 25h-5M60 25h5'/%3E%3C/svg%3E");
            mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cpath d='M50 20c10-10 30-10 40 0 5 10 5 20 0 30-5 10-20 20-40 30-20-10-35-20-40-30-5-10-5-20 0-30 10-10 30-10 40 0z'/%3E%3Cpath d='M30 40c-5 5-5 15 0 20 5 5 15 5 20 0 5 5 15 5 20 0 5-5 5-15 0-20-5-5-15-5-20 0-5-5-15-5-20 0z'/%3E%3Cpath d='M35 35l-5 15M65 35l5 15M50 20v-5M40 25h-5M60 25h5'/%3E%3C/svg%3E");
            -webkit-mask-repeat: no-repeat;
            mask-repeat: no-repeat;
            -webkit-mask-position: center;
            mask-position: center;
            -webkit-mask-size: contain;
            mask-size: contain;
        }
        
        .title {
            font-family: 'Dancing Script', cursive;
            font-size: 3.5rem;
            color: var(--pastel-pink);
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }
        
        .subtitle {
            font-family: 'Caveat', cursive;
            font-size: 1.4rem;
            color: var(--pastel-lavender);
            margin-top: 5px;
        }
        
        /* Sidebar - Planning Tools */
        .sidebar {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            border: 1px solid var(--pastel-pink);
            height: fit-content;
        }
        
        .sidebar-title {
            font-family: 'Caveat', cursive;
            font-size: 2rem;
            color: var(--pastel-pink);
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px dashed var(--pastel-pink);
            text-align: center;
        }
        
        .tool-item {
            background: var(--soft-cream);
            border: 2px solid transparent;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            cursor: grab;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 12px;
            position: relative;
        }
        
        .tool-item:hover {
            transform: translateX(5px);
            border-color: var(--pastel-pink);
            box-shadow: 0 4px 12px rgba(248, 215, 218, 0.3);
        }
        
        .tool-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2rem;
            flex-shrink: 0;
        }
        
        .icon-character { background: var(--pastel-pink); }
        .icon-scene { background: var(--pastel-lavender); }
        .icon-timeline { background: var(--pastel-mint); }
        .icon-world { background: var(--pastel-peach); }
        .icon-outline { background: var(--pastel-blue); }
        .icon-notes { background: var(--pastel-lavender); }
        .icon-image { background: var(--pastel-pink); }
        
        .tool-info h4 {
            font-weight: 600;
            color: var(--muted-charcoal);
            margin-bottom: 4px;
        }
        
        .tool-info p {
            font-size: 0.9rem;
            color: #999;
        }
        
        /* Main Content */
        .main-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.06);
            border: 1px solid var(--pastel-pink);
            min-height: 700px;
            position: relative;
        }
        
        .content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px dashed var(--pastel-pink);
        }
        
        .section-title {
            font-family: 'Caveat', cursive;
            font-size: 2.5rem;
            color: var(--pastel-pink);
        }
        
        .page-number {
            font-family: 'Inter', monospace;
            color: var(--pastel-lavender);
            font-size: 1rem;
            background: var(--soft-cream);
            padding: 5px 15px;
            border-radius: 20px;
            border: 1px solid var(--pastel-pink);
        }
        
        /* Tabs - Simplified */
        .tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 25px;
            border-bottom: 2px solid var(--pastel-pink);
            padding-bottom: 5px;
            overflow-x: auto;
            white-space: nowrap;
        }
        
        .tab-btn {
            padding: 10px 20px;
            background: transparent;
            border: none;
            border-radius: 10px 10px 0 0;
            font-family: 'Inter', sans-serif;
            font-weight: 500;
            color: #999;
            cursor: pointer;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }
        
        .tab-btn.active {
            background: var(--pastel-pink);
            color: white;
        }
        
        .tab-btn:hover:not(.active) {
            background: var(--soft-cream);
            color: var(--pastel-pink);
        }
        
        .tab-content {
            display: none;
            min-height: 500px;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Writing Area - Enhanced */
        .writing-area {
            width: 100%;
            height: 500px;
            padding: 20px;
            border: 1px solid var(--pastel-pink);
            border-radius: 10px;
            font-family: 'Inter', sans-serif;
            font-size: 1rem;
            line-height: 1.8;
            color: var(--muted-charcoal);
            background: var(--soft-cream);
            resize: none;
            outline: none;
        }
        
        .writing-area::placeholder {
            color: var(--pastel-lavender);
            opacity: 0.7;
        }
        
        /* Tool Cards */
        .tool-card {
            background: white;
            border: 2px solid var(--pastel-pink);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            position: relative;
            transition: all 0.3s ease;
            margin-bottom: 20px;
        }
        
        .tool-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(248, 215, 218, 0.3);
        }
        
        .delete-tool {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: var(--pastel-pink);
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
        }
        
        .tool-card-title {
            font-family: 'Caveat', cursive;
            font-size: 1.8rem;
            color: var(--pastel-pink);
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px dashed var(--pastel-pink);
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: var(--muted-charcoal);
            font-weight: 500;
            font-size: 0.9rem;
        }
        
        .form-input {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid var(--pastel-pink);
            border-radius: 8px;
            font-family: 'Inter', sans-serif;
            font-size: 0.95rem;
            color: var(--muted-charcoal);
            background: var(--soft-cream);
            transition: all 0.3s ease;
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--pastel-lavender);
            box-shadow: 0 0 0 3px rgba(212, 196, 230, 0.2);
        }
        
        .form-textarea {
            min-height: 80px;
            resize: vertical;
        }
        
        /* Image Upload Area */
        .image-upload-area {
            border: 2px dashed var(--pastel-pink);
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            margin-bottom: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: var(--soft-cream);
        }
        
        .image-upload-area:hover {
            border-color: var(--pastel-lavender);
            background: rgba(248, 215, 218, 0.1);
        }
        
        .image-upload-area i {
            font-size: 2.5rem;
            color: var(--pastel-pink);
            margin-bottom: 15px;
        }
        
        .image-preview {
            max-width: 100%;
            max-height: 300px;
            margin: 15px auto;
            border-radius: 8px;
            display: none;
        }
        
        .images-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .image-item {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .image-item img {
            width: 100%;
            height: 150px;
            object-fit: cover;
            transition: transform 0.3s ease;
        }
        
        .image-item:hover img {
            transform: scale(1.05);
        }
        
        .image-item button {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(0,0,0,0.5);
            color: white;
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 15px;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px dashed var(--pastel-pink);
        }
        
        .action-btn {
            flex: 1;
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            font-family: 'Inter', sans-serif;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .action-btn.save {
            background: var(--pastel-pink);
            color: white;
        }
        
        .action-btn.export {
            background: var(--pastel-mint);
            color: var(--muted-charcoal);
        }
        
        .action-btn.print {
            background: var(--pastel-lavender);
            color: white;
        }
        
        .action-btn.clear {
            background: var(--pastel-peach);
            color: var(--muted-charcoal);
        }
        
        .action-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        /* Stats Box */
        .stats-box {
            background: var(--soft-cream);
            border-radius: 12px;
            padding: 20px;
            margin-top: 30px;
            border: 1px solid var(--pastel-pink);
        }
        
        .stats-title {
            font-family: 'Caveat', cursive;
            font-size: 1.5rem;
            color: var(--pastel-pink);
            margin-bottom: 15px;
            text-align: center;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }
        
        .stat-item {
            text-align: center;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border: 1px solid var(--pastel-pink);
        }
        
        .stat-value {
            font-size: 1.8rem;
            font-weight: 600;
            color: var(--pastel-pink);
            display: block;
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: var(--muted-charcoal);
        }
        
        /* Footer */
        .footer {
            grid-column: 1 / -1;
            text-align: center;
            padding: 25px;
            margin-top: 30px;
            color: var(--pastel-lavender);
            font-size: 0.9rem;
            border-top: 2px dashed var(--pastel-pink);
        }
        
        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--pastel-mint);
            color: var(--muted-charcoal);
            padding: 15px 25px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            display: none;
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        /* Responsive */
        @media (max-width: 1024px) {
            .container {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 768px) {
            .title {
                font-size: 2.5rem;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 480px) {
            .container {
                padding: 10px;
            }
            
            .header {
                padding: 20px 15px;
            }
            
            .main-content {
                padding: 20px;
            }
            
            .tab-btn {
                padding: 8px 15px;
                font-size: 0.9rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="logo-container">
                <div class="angel-logo"></div>
                <div>
                    <h1 class="title">Novel Planner</h1>
                    <p class="subtitle">Hobonichi Style Writing Studio</p>
                </div>
            </div>
        </header>

        <!-- Left Sidebar - Planning Tools -->
        <aside class="sidebar">
            <h2 class="sidebar-title">Planning Tools</h2>
            
            <div class="tool-item draggable" data-tool="character" draggable="true">
                <div class="tool-icon icon-character">
                    <i class="fas fa-user"></i>
                </div>
                <div class="tool-info">
                    <h4>Character Builder</h4>
                    <p>Create detailed character profiles</p>
                </div>
            </div>
            
            <div class="tool-item draggable" data-tool="scene" draggable="true">
                <div class="tool-icon icon-scene">
                    <i class="fas fa-map"></i>
                </div>
                <div class="tool-info">
                    <h4>Scene Card</h4>
                    <p>Plan individual scenes</p>
                </div>
            </div>
            
            <div class="tool-item draggable" data-tool="world" draggable="true">
                <div class="tool-icon icon-world">
                    <i class="fas fa-globe"></i>
                </div>
                <div class="tool-info">
                    <h4>World Building</h4>
                    <p>Create your story's world</p>
                </div>
            </div>
            
            <div class="tool-item draggable" data-tool="outline" draggable="true">
                <div class="tool-icon icon-outline">
                    <i class="fas fa-list-ol"></i>
                </div>
                <div class="tool-info">
                    <h4>Chapter Outline</h4>
                    <p>Structure your chapters</p>
                </div>
            </div>
            
            <div class="tool-item draggable" data-tool="image" draggable="true">
                <div class="tool-icon icon-image">
                    <i class="fas fa-image"></i>
                </div>
                <div class="tool-info">
                    <h4>Image Upload</h4>
                    <p>Add images for inspiration</p>
                </div>
            </div>
            
            <div class="tool-item" onclick="addNote()">
                <div class="tool-icon icon-notes">
                    <i class="fas fa-sticky-note"></i>
                </div>
                <div class="tool-info">
                    <h4>Quick Note</h4>
                    <p>Add quick thoughts and ideas</p>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="content-header">
                <h2 class="section-title">Your Novel Workspace</h2>
                <div class="page-number">Page <span id="currentPage">1</span></div>
            </div>
            
            <!-- Tabs -->
            <div class="tabs">
                <button class="tab-btn active" data-tab="writing">‚úçÔ∏è Writing</button>
                <button class="tab-btn" data-tab="characters">üë• Characters</button>
                <button class="tab-btn" data-tab="scenes">üé¨ Scenes</button>
                <button class="tab-btn" data-tab="world">üåé World</button>
                <button class="tab-btn" data-tab="outline">üìö Outline</button>
                <button class="tab-btn" data-tab="images">üñºÔ∏è Images</button>
                <button class="tab-btn" data-tab="export">üì§ Export</button>
            </div>
            
            <!-- Tab Contents -->
            <div class="tab-content active" id="writing-tab">
                <textarea class="writing-area" placeholder="Begin writing your story here... ‚úçÔ∏è" id="mainWritingArea"></textarea>
                <div style="display: flex; justify-content: space-between; margin-top: 10px; color: var(--pastel-lavender);">
                    <div>Word Count: <span id="wordCount">0</span></div>
                    <div>Characters: <span id="charCount">0</span></div>
                </div>
            </div>
            
            <div class="tab-content" id="characters-tab">
                <div id="charactersContainer">
                    <!-- Characters will be added here -->
                </div>
                <button class="action-btn save" onclick="addCharacterForm()">
                    <i class="fas fa-plus"></i> Add Character
                </button>
            </div>
            
            <div class="tab-content" id="scenes-tab">
                <div id="scenesContainer">
                    <!-- Scenes will be added here -->
                </div>
                <button class="action-btn save" onclick="addSceneForm()">
                    <i class="fas fa-plus"></i> Add Scene
                </button>
            </div>
            
            <div class="tab-content" id="world-tab">
                <div id="worldContainer">
                    <!-- World building will be added here -->
                </div>
                <button class="action-btn save" onclick="addWorldForm()">
                    <i class="fas fa-plus"></i> Add World Element
                </button>
            </div>
            
            <div class="tab-content" id="outline-tab">
                <div id="outlineContainer">
                    <!-- Outline will be added here -->
                </div>
                <button class="action-btn save" onclick="addOutlineForm()">
                    <i class="fas fa-plus"></i> Add Chapter
                </button>
            </div>
            
            <div class="tab-content" id="images-tab">
                <div class="image-upload-area" id="imageUploadArea">
                    <i class="fas fa-cloud-upload-alt"></i>
                    <h3>Drag & Drop Images Here</h3>
                    <p style="margin: 10px 0; color: var(--pastel-lavender);">
                        or click to upload (JPG, PNG, GIF)
                    </p>
                    <input type="file" id="imageInput" accept="image/*" style="display: none;" multiple>
                    <button class="action-btn save" onclick="document.getElementById('imageInput').click()">
                        <i class="fas fa-folder-open"></i> Browse Files
                    </button>
                </div>
                
                <div id="imagesContainer" class="images-grid">
                    <!-- Images will be displayed here -->
                </div>
            </div>
            
            <div class="tab-content" id="export-tab">
                <div class="stats-box">
                    <h3 class="stats-title">Your Novel Summary</h3>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <span class="stat-value" id="exportWords">0</span>
                            <span class="stat-label">Words</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-value" id="exportCharacters">0</span>
                            <span class="stat-label">Characters</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-value" id="exportScenes">0</span>
                            <span class="stat-label">Scenes</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-value" id="exportChapters">0</span>
                            <span class="stat-label">Chapters</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-value" id="exportWorldElements">0</span>
                            <span class="stat-label">World Elements</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-value" id="exportImages">0</span>
                            <span class="stat-label">Images</span>
                        </div>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="action-btn save" onclick="saveManuscript()">
                        <i class="fas fa-save"></i> Save Locally
                    </button>
                    <button class="action-btn export" onclick="exportToPDF()">
                        <i class="fas fa-file-pdf"></i> Export PDF
                    </button>
                    <button class="action-btn print" onclick="printManuscript()">
                        <i class="fas fa-print"></i> Print
                    </button>
                </div>
                
                <div class="tool-card" style="margin-top: 30px;">
                    <h3 class="tool-card-title">Export Options</h3>
                    <div class="form-group">
                        <label for="exportTitle">Document Title:</label>
                        <input type="text" id="exportTitle" class="form-input" value="My Novel Plan" placeholder="Enter document title">
                    </div>
                    <div class="form-group">
                        <label for="exportAuthor">Author Name:</label>
                        <input type="text" id="exportAuthor" class="form-input" placeholder="Your name">
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="includeImages" checked> Include Images in PDF
                        </label>
                        <label>
                            <input type="checkbox" id="includeWriting" checked> Include Writing Content
                        </label>
                        <label>
                            <input type="checkbox" id="includePlanning" checked> Include Planning Elements
                        </label>
                    </div>
                    <button class="action-btn export" onclick="exportToPDF()" style="width: 100%; margin-top: 20px;">
                        <i class="fas fa-download"></i> Generate Complete PDF
                    </button>
                </div>
            </div>
        </main>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification"></div>

    <script>
        // State management
        let manuscript = {
            writing: '',
            characters: [],
            scenes: [],
            worldbuilding: [],
            outlines: [],
            images: [],
            metadata: {
                title: 'My Novel Plan',
                author: '',
                created: new Date().toISOString(),
                lastModified: new Date().toISOString()
            }
        };

        // DOM elements
        const writingArea = document.getElementById('mainWritingArea');
        const notification = document.getElementById('notification');
        const tabBtns = document.querySelectorAll('.tab-btn');
        const tabContents = document.querySelectorAll('.tab-content');
        const imageInput = document.getElementById('imageInput');
        const imageUploadArea = document.getElementById('imageUploadArea');

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadFromStorage();
            setupTabs();
            setupEventListeners();
            setupImageUpload();
            updateStats();
            
            // Auto-save every 30 seconds
            setInterval(saveManuscript, 30000);
            
            // Update modified date
            setInterval(() => {
                manuscript.metadata.lastModified = new Date().toISOString();
            }, 60000);
        });

        // Setup tabs
        function setupTabs() {
            tabBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    
                    tabBtns.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    
                    tabContents.forEach(content => {
                        content.classList.remove('active');
                        if (content.id === `${tabId}-tab`) {
                            content.classList.add('active');
                        }
                    });
                    
                    if (tabId === 'export') {
                        updateExportStats();
                    }
                });
            });
        }

        // Setup event listeners
        function setupEventListeners() {
            writingArea.addEventListener('input', function() {
                manuscript.writing = this.value;
                updateStats();
            });
            
            // Setup drag and drop for tools
            document.querySelectorAll('.draggable').forEach(item => {
                item.addEventListener('dragstart', function(e) {
                    e.dataTransfer.setData('text/plain', this.getAttribute('data-tool'));
                    this.style.opacity = '0.5';
                });
                
                item.addEventListener('dragend', function() {
                    this.style.opacity = '1';
                });
            });
            
            // Allow dropping anywhere in main content
            document.querySelector('.main-content').addEventListener('dragover', function(e) {
                e.preventDefault();
            });
            
            document.querySelector('.main-content').addEventListener('drop', function(e) {
                e.preventDefault();
                const toolType = e.dataTransfer.getData('text/plain');
                if (toolType) {
                    addToolForm(toolType);
                }
            });
        }

        // Setup image upload
        function setupImageUpload() {
            // Click to upload
            imageUploadArea.addEventListener('click', function() {
                imageInput.click();
            });
            
            // Drag and drop for images
            imageUploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                this.style.borderColor = 'var(--pastel-lavender)';
                this.style.background = 'rgba(248, 215, 218, 0.1)';
            });
            
            imageUploadArea.addEventListener('dragleave', function() {
                this.style.borderColor = 'var(--pastel-pink)';
                this.style.background = 'var(--soft-cream)';
            });
            
            imageUploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                this.style.borderColor = 'var(--pastel-pink)';
                this.style.background = 'var(--soft-cream)';
                
                const files = e.dataTransfer.files;
                handleImageFiles(files);
            });
            
            // File input change
            imageInput.addEventListener('change', function(e) {
                handleImageFiles(e.target.files);
            });
        }

        // Handle image files
        function handleImageFiles(files) {
            Array.from(files).forEach(file => {
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        addImage(e.target.result, file.name);
                    };
                    reader.readAsDataURL(file);
                }
            });
        }

        // Add image to manuscript
        function addImage(dataUrl, filename) {
            const imageId = Date.now();
            const image = {
                id: imageId,
                data: dataUrl,
                name: filename,
                date: new Date().toISOString()
            };
            
            manuscript.images.push(image);
            displayImage(image);
            updateStats();
            showNotification('Image added successfully!', 'success');
        }

        // Display image in grid
        function displayImage(image) {
            const container = document.getElementById('imagesContainer');
            const imageHTML = `
                <div class="image-item" id="image-${image.id}">
                    <img src="${image.data}" alt="${image.name}">
                    <button onclick="removeImage(${image.id})">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', imageHTML);
        }

        // Remove image
        function removeImage(imageId) {
            manuscript.images = manuscript.images.filter(img => img.id !== imageId);
            document.getElementById(`image-${imageId}`).remove();
            updateStats();
            showNotification('Image removed', 'info');
        }

        // Add tool forms
        function addToolForm(toolType) {
            let formHTML = '';
            const toolId = Date.now();
            
            switch(toolType) {
                case 'character':
                    formHTML = createCharacterForm(toolId);
                    break;
                case 'scene':
                    formHTML = createSceneForm(toolId);
                    break;
                case 'world':
                    formHTML = createWorldForm(toolId);
                    break;
                case 'outline':
                    formHTML = createOutlineForm(toolId);
                    break;
                case 'image':
                    // Just focus on images tab
                    tabBtns.forEach(b => b.classList.remove('active'));
                    tabContents.forEach(c => c.classList.remove('active'));
                    document.querySelector('[data-tab="images"]').classList.add('active');
                    document.getElementById('images-tab').classList.add('active');
                    imageInput.click();
                    return;
            }
            
            // Add to appropriate tab container
            const container = document.getElementById(`${toolType}sContainer`);
            if (container) {
                container.insertAdjacentHTML('beforeend', formHTML);
                // Switch to that tab
                tabBtns.forEach(b => b.classList.remove('active'));
                tabContents.forEach(c => c.classList.remove('active'));
                document.querySelector(`[data-tab="${toolType}s"]`).classList.add('active');
                document.getElementById(`${toolType}s-tab`).classList.add('active');
            }
        }

        // Form creation functions
        function createCharacterForm(id) {
            return `
                <div class="tool-card" id="character-${id}">
                    <button class="delete-tool" onclick="removeForm('character', ${id})">√ó</button>
                    <h3 class="tool-card-title">New Character</h3>
                    <div class="form-group">
                        <label>Name:</label>
                        <input type="text" class="form-input" id="char-name-${id}" placeholder="Character Name">
                    </div>
                    <div class="form-group">
                        <label>Role:</label>
                        <select class="form-input" id="char-role-${id}">
                            <option value="">Select Role</option>
                            <option value="protagonist">Protagonist</option>
                            <option value="antagonist">Antagonist</option>
                            <option value="supporting">Supporting</option>
                            <option value="minor">Minor</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Age:</label>
                        <input type="text" class="form-input" id="char-age-${id}" placeholder="Character Age">
                    </div>
                    <div class="form-group">
                        <label>Appearance:</label>
                        <textarea class="form-input form-textarea" id="char-appearance-${id}" placeholder="Physical description..."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Personality:</label>
                        <textarea class="form-input form-textarea" id="char-personality-${id}" placeholder="Personality traits..."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Backstory:</label>
                        <textarea class="form-input form-textarea" id="char-backstory-${id}" placeholder="Character's history..."></textarea>
                    </div>
                    <button class="action-btn save" onclick="saveCharacter(${id})">
                        <i class="fas fa-save"></i> Save Character
                    </button>
                </div>
            `;
        }

        function createSceneForm(id) {
            return `
                <div class="tool-card" id="scene-${id}">
                    <button class="delete-tool" onclick="removeForm('scene', ${id})">√ó</button>
                    <h3 class="tool-card-title">New Scene</h3>
                    <div class="form-group">
                        <label>Scene Title:</label>
                        <input type="text" class="form-input" id="scene-title-${id}" placeholder="Scene Title">
                    </div>
                    <div class="form-group">
                        <label>Chapter:</label>
                        <input type="text" class="form-input" id="scene-chapter-${id}" placeholder="Chapter Number">
                    </div>
                    <div class="form-group">
                        <label>Location:</label>
                        <input type="text" class="form-input" id="scene-location-${id}" placeholder="Where does this happen?">
                    </div>
                    <div class="form-group">
                        <label>Characters:</label>
                        <input type="text" class="form-input" id="scene-characters-${id}" placeholder="Which characters appear?">
                    </div>
                    <div class="form-group">
                        <label>Purpose:</label>
                        <input type="text" class="form-input" id="scene-purpose-${id}" placeholder="What's the scene's purpose?">
                    </div>
                    <div class="form-group">
                        <label>Summary:</label>
                        <textarea class="form-input form-textarea" id="scene-summary-${id}" placeholder="What happens in this scene?"></textarea>
                    </div>
                    <button class="action-btn save" onclick="saveScene(${id})">
                        <i class="fas fa-save"></i> Save Scene
                    </button>
                </div>
            `;
        }

        function createWorldForm(id) {
            return `
                <div class="tool-card" id="world-${id}">
                    <button class="delete-tool" onclick="removeForm('world', ${id})">√ó</button>
                    <h3 class="tool-card-title">World Building</h3>
                    <div class="form-group">
                        <label>Category:</label>
                        <select class="form-input" id="world-category-${id}">
                            <option value="location">Location</option>
                            <option value="culture">Culture</option>
                            <option value="magic">Magic System</option>
                            <option value="technology">Technology</option>
                            <option value="religion">Religion</option>
                            <option value="politics">Politics</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Name:</label>
                        <input type="text" class="form-input" id="world-name-${id}" placeholder="Kingdom/Culture/System Name">
                    </div>
                    <div class="form-group">
                        <label>Description:</label>
                        <textarea class="form-input form-textarea" id="world-desc-${id}" placeholder="Detailed description..."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Key Features:</label>
                        <textarea class="form-input form-textarea" id="world-features-${id}" placeholder="Key features and characteristics..."></textarea>
                    </div>
                    <button class="action-btn save" onclick="saveWorld(${id})">
                        <i class="fas fa-save"></i> Save World Element
                    </button>
                </div>
            `;
        }

        function createOutlineForm(id) {
            return `
                <div class="tool-card" id="outline-${id}">
                    <button class="delete-tool" onclick="removeForm('outline', ${id})">√ó</button>
                    <h3 class="tool-card-title">Chapter Outline</h3>
                    <div class="form-group">
                        <label>Chapter Number:</label>
                        <input type="text" class="form-input" id="outline-chapter-${id}" placeholder="Chapter 1">
                    </div>
                    <div class="form-group">
                        <label>Chapter Title:</label>
                        <input type="text" class="form-input" id="outline-title-${id}" placeholder="Chapter Title">
                    </div>
                    <div class="form-group">
                        <label>POV Character:</label>
                        <input type="text" class="form-input" id="outline-pov-${id}" placeholder="Whose perspective?">
                    </div>
                    <div class="form-group">
                        <label>Location:</label>
                        <input type="text" class="form-input" id="outline-location-${id}" placeholder="Where does this happen?">
                    </div>
                    <div class="form-group">
                        <label>Summary:</label>
                        <textarea class="form-input form-textarea" id="outline-summary-${id}" placeholder="What happens in this chapter?"></textarea>
                    </div>
                    <button class="action-btn save" onclick="saveOutline(${id})">
                        <i class="fas fa-save"></i> Save Chapter
                    </button>
                </div>
            `;
        }

        // Quick add functions
        function addCharacterForm() { addToolForm('character'); }
        function addSceneForm() { addToolForm('scene'); }
        function addWorldForm() { addToolForm('world'); }
        function addOutlineForm() { addToolForm('outline'); }
        function addNote() {
            const note = prompt("Enter your quick note:");
            if (note) {
                showNotification('Note saved!', 'success');
            }
        }

        // Remove form
        function removeForm(type, id) {
            document.getElementById(`${type}-${id}`).remove();
        }

        // Save functions
        function saveCharacter(id) {
            const character = {
                id: id,
                name: document.getElementById(`char-name-${id}`).value,
                role: document.getElementById(`char-role-${id}`).value,
                age: document.getElementById(`char-age-${id}`).value,
                appearance: document.getElementById(`char-appearance-${id}`).value,
                personality: document.getElementById(`char-personality-${id}`).value,
                backstory: document.getElementById(`char-backstory-${id}`).value,
                date: new Date().toISOString()
            };
            
            manuscript.characters.push(character);
            updateStats();
            showNotification('Character saved!', 'success');
        }

        function saveScene(id) {
            const scene = {
                id: id,
                title: document.getElementById(`scene-title-${id}`).value,
                chapter: document.getElementById(`scene-chapter-${id}`).value,
                location: document.getElementById(`scene-location-${id}`).value,
                characters: document.getElementById(`scene-characters-${id}`).value,
                purpose: document.getElementById(`scene-purpose-${id}`).value,
                summary: document.getElementById(`scene-summary-${id}`).value,
                date: new Date().toISOString()
            };
            
            manuscript.scenes.push(scene);
            updateStats();
            showNotification('Scene saved!', 'success');
        }

        function saveWorld(id) {
            const world = {
                id: id,
                category: document.getElementById(`world-category-${id}`).value,
                name: document.getElementById(`world-name-${id}`).value,
                description: document.getElementById(`world-desc-${id}`).value,
                features: document.getElementById(`world-features-${id}`).value,
                date: new Date().toISOString()
            };
            
            manuscript.worldbuilding.push(world);
            updateStats();
            showNotification('World element saved!', 'success');
        }

        function saveOutline(id) {
            const outline = {
                id: id,
                chapter: document.getElementById(`outline-chapter-${id}`).value,
                title: document.getElementById(`outline-title-${id}`).value,
                pov: document.getElementById(`outline-pov-${id}`).value,
                location: document.getElementById(`outline-location-${id}`).value,
                summary: document.getElementById(`outline-summary-${id}`).value,
                date: new Date().toISOString()
            };
            
            manuscript.outlines.push(outline);
            updateStats();
            showNotification('Chapter outline saved!', 'success');
        }

        // Update stats
        function updateStats() {
            const words = writingArea.value.trim() === '' ? 0 : writingArea.value.trim().split(/\s+/).length;
            const chars = writingArea.value.length;
            
            document.getElementById('wordCount').textContent = words;
            document.getElementById('charCount').textContent = chars;
        }

        function updateExportStats() {
            const words = writingArea.value.trim() === '' ? 0 : writingArea.value.trim().split(/\s+/).length;
            
            document.getElementById('exportWords').textContent = words;
            document.getElementById('exportCharacters').textContent = manuscript.characters.length;
            document.getElementById('exportScenes').textContent = manuscript.scenes.length;
            document.getElementById('exportChapters').textContent = manuscript.outlines.length;
            document.getElementById('exportWorldElements').textContent = manuscript.worldbuilding.length;
            document.getElementById('exportImages').textContent = manuscript.images.length;
        }

        // Save/Load functions
        function saveManuscript() {
            manuscript.metadata.lastModified = new Date().toISOString();
            manuscript.writing = writingArea.value;
            
            localStorage.setItem('novelPlannerManuscript', JSON.stringify(manuscript));
            showNotification('Manuscript saved locally!', 'success');
        }

        function loadFromStorage() {
            const saved = localStorage.getItem('novelPlannerManuscript');
            if (saved) {
                try {
                    manuscript = JSON.parse(saved);
                    writingArea.value = manuscript.writing || '';
                    
                    // Display saved images
                    manuscript.images.forEach(image => displayImage(image));
                    
                    showNotification('Manuscript loaded from storage', 'info');
                } catch (e) {
                    console.error('Error loading saved data:', e);
                }
            }
            updateStats();
        }

        // Export to PDF
        async function exportToPDF() {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4');
            
            const title = document.getElementById('exportTitle').value || manuscript.metadata.title;
            const author = document.getElementById('exportAuthor').value || 'Anonymous';
            const includeImages = document.getElementById('includeImages').checked;
            const includeWriting = document.getElementById('includeWriting').checked;
            const includePlanning = document.getElementById('includePlanning').checked;
            
            // Title Page
            pdf.setFontSize(24);
            pdf.setTextColor(248, 215, 218);
            pdf.text(title, 105, 100, { align: 'center' });
            
            pdf.setFontSize(16);
            pdf.setTextColor(212, 196, 230);
            pdf.text(`by ${author}`, 105, 115, { align: 'center' });
            
            pdf.setFontSize(12);
            pdf.setTextColor(90, 90, 90);
            pdf.text(`Generated on ${new Date().toLocaleDateString()}`, 105, 125, { align: 'center' });
            
            pdf.addPage();
            
            // Table of Contents
            pdf.setFontSize(18);
            pdf.setTextColor(193, 225, 210);
            pdf.text('Table of Contents', 20, 30);
            
            let y = 40;
            pdf.setFontSize(11);
            pdf.setTextColor(0, 0, 0);
            
            if (includeWriting) {
                pdf.text('1. Writing Content', 30, y); y += 7;
            }
            if (includePlanning && manuscript.characters.length > 0) {
                pdf.text('2. Characters', 30, y); y += 7;
            }
            if (includePlanning && manuscript.scenes.length > 0) {
                pdf.text('3. Scenes', 30, y); y += 7;
            }
            if (includePlanning && manuscript.worldbuilding.length > 0) {
                pdf.text('4. World Building', 30, y); y += 7;
            }
            if (includePlanning && manuscript.outlines.length > 0) {
                pdf.text('5. Chapter Outline', 30, y); y += 7;
            }
            if (includeImages && manuscript.images.length > 0) {
                pdf.text('6. Images', 30, y); y += 7;
            }
            
            // Add content pages
            if (includeWriting && manuscript.writing) {
                pdf.addPage();
                pdf.setFontSize(16);
                pdf.setTextColor(248, 215, 218);
                pdf.text('Writing Content', 20, 20);
                
                pdf.setFontSize(11);
                pdf.setTextColor(0, 0, 0);
                const lines = pdf.splitTextToSize(manuscript.writing, 170);
                pdf.text(lines, 20, 30);
            }
            
            if (includePlanning) {
                // Add planning sections
                if (manuscript.characters.length > 0) {
                    pdf.addPage();
                    pdf.setFontSize(16);
                    pdf.setTextColor(248, 215, 218);
                    pdf.text('Characters', 20, 20);
                    
                    pdf.setFontSize(11);
                    pdf.setTextColor(0, 0, 0);
                    y = 30;
                    manuscript.characters.forEach(char => {
                        pdf.text(`${char.name} - ${char.role}`, 20, y);
                        y += 5;
                        if (y > 280) {
                            pdf.addPage();
                            y = 20;
                        }
                    });
                }
            }
            
            // Save PDF
            pdf.save(`${title.replace(/[^a-z0-9]/gi, '_')}_Novel_Plan.pdf`);
            showNotification('PDF exported successfully!', 'success');
        }

        // Print manuscript
        function printManuscript() {
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
                    <title>Print Manuscript</title>
                    <style>
                        body { font-family: 'Inter', sans-serif; padding: 20px; }
                        h1 { color: #F8D7DA; }
                        .section { margin-bottom: 30px; }
                        .image { max-width: 300px; margin: 10px 0; }
                    </style>
                </head>
                <body>
                    <h1>${manuscript.metadata.title}</h1>
                    <p>by ${manuscript.metadata.author || 'Anonymous'}</p>
                    <hr>
                    
                    ${manuscript.writing ? `
                    <div class="section">
                        <h2>Writing Content</h2>
                        <p>${manuscript.writing.replace(/\n/g, '<br>')}</p>
                    </div>
                    ` : ''}
                    
                    ${manuscript.characters.length > 0 ? `
                    <div class="section">
                        <h2>Characters (${manuscript.characters.length})</h2>
                        ${manuscript.characters.map(char => `
                            <h3>${char.name}</h3>
                            <p><strong>Role:</strong> ${char.role}</p>
                            ${char.age ? `<p><strong>Age:</strong> ${char.age}</p>` : ''}
                            ${char.appearance ? `<p><strong>Appearance:</strong> ${char.appearance}</p>` : ''}
                            <hr>
                        `).join('')}
                    </div>
                    ` : ''}
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        // Show notification
        function showNotification(message, type = 'info') {
            notification.textContent = message;
            notification.style.display = 'block';
            notification.style.background = type === 'error' ? '#ffcccc' :
                                          type === 'success' ? 'var(--pastel-mint)' :
                                          'var(--pastel-blue)';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }

        // Auto-save on exit
        window.addEventListener('beforeunload', function(e) {
            saveManuscript();
        });
    </script>
</body>
</html>
